<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skript IDE - Ultimate Power Edition</title>
    <style>
        :root {
            --bg: #282a36; --sidebar: #1e1f29; --fg: #f8f8f2;
            --purple: #bd93f9; --selection: #44475a; --comment: #6272a4;
            --cyan: #8be9fd; --pink: #ff79c6; --green: #50fa7b; 
            --orange: #ffb86c; --red: #ff5555; --yellow: #f1fa8c;
            --line-height: 22px;
        }
        
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: 'Inter', sans-serif; overflow: hidden; color: var(--fg); }
        .container { display: flex; height: 100vh; width: 100vw; }
        
        /* Sidebar */
        .sidebar { width: 240px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid #111; z-index: 10; transition: width 0.2s; }
        .sidebar.collapsed { width: 0; overflow: hidden; border: none; }
        .sidebar-header { padding: 15px; font-size: 13px; font-weight: bold; color: var(--purple); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; }
        
        .project-list { flex: 1; padding: 5px; overflow-y: auto; }
        .project-item { padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; margin-bottom: 2px; white-space: nowrap; transition: 0.2s; display: flex; justify-content: space-between; }
        .project-item:hover { background: var(--selection); }
        .project-item.active { background: var(--purple); color: #000; font-weight: bold; }

        /* Main Area */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; }
        .toolbar { height: 40px; background: var(--sidebar); display: flex; align-items: center; padding: 0 10px; border-bottom: 1px solid #111; gap: 10px; }
        .tool-btn { background: var(--selection); border: 1px solid rgba(255,255,255,0.1); color: var(--fg); padding: 4px 10px; border-radius: 3px; cursor: pointer; font-size: 11px; }
        
        /* Editor */
        .editor-container { flex: 3; position: relative; display: flex; background: var(--bg); overflow: hidden; border-bottom: 2px solid #111; }
        .code-font { font-family: 'Fira Code', 'Consolas', monospace; font-size: 14px; line-height: var(--line-height); }
        #gutter { width: 45px; background: var(--sidebar); color: var(--comment); text-align: right; padding-top: 10px; user-select: none; border-right: 1px solid rgba(255,255,255,0.05); }
        .line-num { padding-right: 10px; height: var(--line-height); }
        
        .input-area { flex: 1; position: relative; overflow: hidden; }
        #editing, #highlighting { position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 10px; border: 0; tab-size: 4; white-space: pre; word-wrap: normal; box-sizing: border-box; overflow: auto; }
        #editing { z-index: 3; background: transparent; color: transparent; caret-color: #fff; outline: none; resize: none; }
        #highlighting { z-index: 2; pointer-events: none; }

        /* Console / Chat Simulator */
        .sim-container { flex: 1.2; background: #0c0c0c; display: flex; flex-direction: column; font-family: monospace; }
        #sim-logs { flex: 1; padding: 10px; overflow-y: auto; font-size: 13px; color: #eee; }
        .sim-input-wrap { display: flex; background: #000; padding: 8px; border-top: 1px solid #333; }
        #sim-input { flex: 1; background: transparent; border: none; color: #55FF55; outline: none; padding-left: 10px; font-family: monospace; }

        /* Syntax Colors */
        .sk-ev { color: var(--pink); font-weight: bold; }
        .sk-eff { color: var(--cyan); }
        .sk-cond { color: var(--yellow); font-weight: bold; }
        .sk-exp { color: var(--purple); }
        .sk-var { color: var(--orange); }
        .sk-comment { color: var(--comment); font-style: italic; }
        .sk-str { color: #a6e22e; } 
        .sk-regex { color: #f1fa8c; background: rgba(255,255,255,0.05); border-radius: 2px; }

        /* Minecraft Formatting Colors */
        .mc-0 { color: #000000; } .mc-1 { color: #0000AA; } .mc-2 { color: #00AA00; } .mc-3 { color: #00AAAA; }
        .mc-4 { color: #AA0000; } .mc-5 { color: #AA00AA; } .mc-6 { color: #FFAA00; } .mc-7 { color: #AAAAAA; }
        .mc-8 { color: #555555; } .mc-9 { color: #5555FF; } .mc-a { color: #55FF55; } .mc-b { color: #55FFFF; }
        .mc-c { color: #FF5555; } .mc-d { color: #FF55FF; } .mc-e { color: #FFFF55; } .mc-f { color: #FFFFFF; }
        .mc-l { font-weight: bold; } .mc-o { font-style: italic; } .mc-n { text-decoration: underline; } .mc-m { text-decoration: line-through; }

        .status-bar { height: 22px; background: var(--sidebar); border-top: 1px solid #111; display: flex; align-items: center; padding: 0 10px; font-size: 10px; color: var(--comment); justify-content: space-between; }
    </style>
</head>
<body>

<div id="auth-modal" style="display:flex; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:var(--sidebar); padding:30px; border-radius:12px; border:1px solid var(--purple); width:320px; text-align:center;">
        <h2 style="margin:0 0 20px 0; color:var(--purple); letter-spacing: 1px;">Skript IDE <small>ULTIMATE</small></h2>
        <input type="text" id="auth-user" style="width:100%; padding:12px; background:#111; border:1px solid #333; color:white; margin-bottom:15px; border-radius:4px;" placeholder="Username">
        <button class="tool-btn" style="width:100%; height:45px; background:var(--purple); color:black; font-weight:bold;" onclick="handleAuth()">INITIALIZE</button>
    </div>
</div>

<div class="container">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span>FILE EXPLORER</span>
            <button class="toggle-side" style="background:transparent; border:none; color:var(--comment); cursor:pointer;" onclick="toggleSidebar()">¬´</button>
        </div>
        <div style="padding: 10px; display: flex; gap: 5px;">
            <button class="tool-btn" style="flex:1" onclick="createFile()">+ NEW</button>
            <button class="tool-btn" style="flex:1" onclick="document.getElementById('file-in').click()">OPEN</button>
        </div>
        <div class="project-list" id="project-list"></div>
    </div>

    <div class="main">
        <div class="toolbar">
            <button class="toggle-side" id="open-btn" style="display:none" onclick="toggleSidebar()">¬ª</button>
            <span id="cur-file" style="font-size: 12px; color: var(--purple); font-weight: bold;">untitled.sk</span>
            <div style="flex:1"></div>
            <button class="tool-btn" onclick="runSimulation()" style="color:var(--green); border-color:var(--green)">‚ñ∂ RELOAD SCRIPT</button>
            <button class="tool-btn" onclick="exportSk()">DOWNLOAD</button>
            <button class="tool-btn" style="background:var(--purple); color:black;" onclick="saveSk(false)">SAVE</button>
        </div>

        <div class="editor-container">
            <div id="gutter" class="code-font"></div>
            <div class="input-area">
                <div id="highlighting" class="code-font"></div>
                <textarea id="editing" class="code-font" spellcheck="false" oninput="onInput()" onscroll="syncScroll()" onkeydown="onKey(event)"></textarea>
            </div>
        </div>

        <div class="sim-container">
            <div id="sim-logs"></div>
            <div class="sim-input-wrap">
                <span style="color:var(--comment)">&gt;</span>
                <input type="text" id="sim-input" placeholder="Type command or chat..." onkeydown="handleSimInput(event)">
            </div>
        </div>

        <div class="status-bar">
            <span id="save-status">Ready</span>
            <span id="cursor-pos">Ln 1, Col 1</span>
        </div>
    </div>
</div>

<input type="file" id="file-in" style="display:none" onchange="importSk(this)">

<script>
    const elIn = document.getElementById('editing');
    const elOut = document.getElementById('highlighting');
    const elGutter = document.getElementById('gutter');
    const elStatus = document.getElementById('save-status');

    let user = null;
    let curFile = null;
    let db = JSON.parse(localStorage.getItem('sk_ultra_db_v6')) || {};
    let autoSaveTimer;

    // Mass Keywords Database
    const colors = {
        ev: ["on join:", "on quit:", "on death:", "on break:", "on place:", "on chat:", "on rightclick:", "on leftclick:", "on load:", "on command:", "on damage:", "on step:", "on world change:", "on pressure plate:", "on swap hand:", "on item spawn:", "on craft:", "on consume:", "on dispense:", "on exp spawn:", "on ignite:", "on explode:", "on grow:", "on spread:", "on piston extend:", "on toggle sneak:", "on toggle flight:", "on pick up:", "on drop:", "on recipe click:", "on packet:", "on nbt load:", "on yaml load:", "on discord message:", "on inventory click:", "on portal:", "on shoot:", "on bucket fill:", "on splash:", "on projectile hit:", "on physics:", "on flow:", "on chunk load:", "on bed enter:"],
        eff: ["set", "add", "remove", "delete", "send", "broadcast", "wait", "stop", "cancel", "teleport", "kill", "spawn", "give", "apply", "execute", "message", "play", "kick", "ban", "op", "deop", "force", "make", "create", "unzip", "download", "load", "save", "write", "rename", "format", "open", "close", "clear", "push", "strike", "heal", "feed", "ignite", "extinguish", "shear", "dye", "equip", "enchant", "disenchant", "repair", "launch", "shoot", "drop", "pickup", "hide", "reveal", "register", "unregister", "connect", "disconnect", "json", "actionbar", "bossbar", "title", "subtitle", "sound", "particle", "hologram", "npc", "citizen", "database", "query", "update", "webhook"],
        cond: ["if", "else", "else if", "has", "exists", "is", "contains", "while", "loop", "can", "greater", "less", "matches", "regex", "starts with", "ends with", "is set", "is not set", "is alive", "is dead", "is online", "is offline", "is sneaking", "is sprinting", "is flying", "is swimming", "is burning", "is blocking", "is sleeping", "is riding", "is holding", "is wearing", "is empty", "is not empty", "exists", "is file", "is directory"],
        exp: ["player", "victim", "attacker", "target", "location", "uuid", "name", "displayname", "world", "now", "yesterday", "distance", "health", "metadata", "event-block", "loop-value", "loop-player", "loop-index", "arg", "argument", "parameter", "message", "sender", "ip", "balance", "money", "nbt", "tag", "compound", "json", "yaml", "file", "folder", "path", "extension", "regex group", "last regex", "time", "date", "weather", "biome", "chunk", "inventory", "slot", "chest", "enderchest", "offhand", "head", "chestplate", "leggings", "boots", "tool", "held item"],
        item: ["stone", "grass", "dirt", "cobblestone", "planks", "sapling", "bedrock", "water", "lava", "sand", "gravel", "gold ore", "iron ore", "coal ore", "log", "leaves", "sponge", "glass", "lapis ore", "dispenser", "sandstone", "note block", "wool", "piston", "tnt", "bookshelf", "mossy cobblestone", "obsidian", "torch", "fire", "chest", "diamond ore", "redstone ore", "ice", "snow", "clay", "pumpkin", "netherrack", "glowstone", "cake", "trapdoor", "stone bricks", "iron bars", "glass pane", "melon", "fence", "gate", "mycelium", "lily pad", "nether brick", "enchantment table", "brewing stand", "cauldron", "end portal", "dragon egg", "redstone lamp", "emerald ore", "anvil", "beacon", "hopper", "quartz", "dropper", "stained glass", "slime block", "iron shovel", "iron pickaxe", "iron axe", "flint and steel", "apple", "bow", "arrow", "coal", "diamond", "iron ingot", "gold ingot", "iron sword", "diamond sword", "stick", "bowl", "soup", "gold sword", "string", "feather", "gunpowder", "hoe", "wheat", "bread", "helmet", "chestplate", "leggings", "boots", "flint", "raw porkchop", "cooked porkchop", "painting", "golden apple", "sign", "wooden door", "bucket", "minecart", "saddle", "iron door", "redstone", "snowball", "boat", "leather", "milk", "brick", "sugar cane", "paper", "book", "slimeball", "egg", "compass", "fishing rod", "clock", "glowstone dust", "raw fish", "cooked fish", "dye", "bone", "sugar", "cookie", "map", "shears", "melon slice", "pumpkin seeds", "melon seeds", "raw beef", "cooked beef", "raw chicken", "cooked chicken", "rotten flesh", "ender pearl", "blaze rod", "ghast tear", "gold nugget", "nether wart", "potion", "glass bottle", "spider eye", "fermented spider eye", "blaze powder", "magma cream", "eye of ender", "glistering melon", "spawn egg", "bottle o' enchanting", "fire charge", "writable book", "written book", "emerald", "item frame", "flower pot", "carrot", "potato", "baked potato", "poisonous potato", "empty map", "golden carrot", "skull", "carrot on a stick", "nether star", "pumpkin pie", "firework rocket", "firework star", "enchanted book", "netherite sword", "netherite pickaxe", "elytra", "trident"]
    };

    const colorMap = {};
    Object.keys(colors).forEach(cat => colors[cat].forEach(word => colorMap[word] = cat));

    function handleAuth() {
        const u = document.getElementById('auth-user').value.trim();
        if(!u) return; user = u;
        if(!db[user]) db[user] = { "tutorial.sk": "on join:\n\tbroadcast \"&a%player% &7joined!\"\n\tsend \"&e&lWelcome!\" to player" };
        document.getElementById('auth-modal').style.display = 'none';
        renderList(); load(Object.keys(db[user])[0]);
    }

    // Fixed Minecraft Formatter (Ignores HTML entities)
    function formatMC(str) {
        let out = "";
        let spans = 0;
        for (let i = 0; i < str.length; i++) {
            if (str[i] === '&' && "0123456789abcdefklmnor".includes(str[i+1]?.toLowerCase())) {
                let code = str[i+1].toLowerCase();
                if (code === 'r') {
                    while (spans > 0) { out += "</span>"; spans--; }
                } else {
                    out += `<span class="mc-${code}">`;
                    spans++;
                }
                i++; continue;
            }
            out += str[i];
        }
        while (spans > 0) { out += "</span>"; spans--; }
        return out;
    }

    function update() {
        const code = elIn.value;
        const lines = code.split('\n');
        elGutter.innerHTML = lines.map((_, i) => `<div class="line-num">${i+1}</div>`).join('');

        // Step 1: Escape HTML tags only
        let html = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        
        // Step 2: Handle comments (preserving & for step 3)
        html = html.replace(/(#.*)/g, '<span class="sk-comment">$1</span>');
        
        // Step 3: Handle strings & MC colors
        html = html.replace(/("(?:[^"\\]|\\.)*")/g, (m) => `<span class="sk-str">${formatMC(m)}</span>`);

        // Step 4: Handle Variables
        html = html.replace(/(\{.*?\})/g, '<span class="sk-var">$1</span>');

        // Step 5: Highlight keywords (ignoring existing spans)
        const tokens = html.split(/(\s+|[.,:!?;])/);
        html = tokens.map(token => {
            if (token.startsWith('<span')) return token;
            const clean = token.toLowerCase();
            if (colorMap[clean]) return `<span class="sk-${colorMap[clean]}">${token}</span>`;
            if (token.endsWith(':') && colorMap[clean.slice(0,-1)]) return `<span class="sk-${colorMap[clean.slice(0,-1)]}">${token}</span>`;
            return token;
        }).join('');

        // Step 6: Final safety escape for standalone & that didn't get formatted
        // We only replace ampersands that aren't part of an HTML tag we just built
        elOut.innerHTML = html.replace(/&(?!(([a-z0-9]+|#[0-9]{1,6}|#x[0-9a-f]{1,6});|mc-|sk-|quot;|lt;|gt;))/gi, "&amp;") + (code.endsWith('\n') ? ' ' : '');
        
        const cur = code.substr(0, elIn.selectionStart).split("\n");
        document.getElementById('cursor-pos').innerText = `Ln ${cur.length}, Col ${cur[cur.length-1].length + 1}`;
    }

    function onInput() {
        update();
        elStatus.innerText = "Saving...";
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => saveSk(true), 1000);
    }

    function saveSk(silent=true) {
        if(!user || !curFile) return;
        db[user][curFile] = elIn.value;
        localStorage.setItem('sk_ultra_db_v6', JSON.stringify(db));
        elStatus.innerText = "Synced";
    }

    function load(f) {
        curFile = f; elIn.value = db[user][f];
        document.getElementById('cur-file').innerText = f;
        update(); renderList();
    }

    function renderList() {
        document.getElementById('project-list').innerHTML = Object.keys(db[user]).map(f => `
            <div class="project-item ${curFile === f ? 'active' : ''}" onclick="load('${f}')">
                <span>${f.endsWith('.sk') ? 'üêù' : 'üìÑ'} ${f}</span>
            </div>
        `).join('');
    }

    function createFile() {
        const n = prompt("Filename (.sk or .txt):");
        if(n) { db[user][n] = "# New file"; load(n); }
    }

    function onKey(e) {
        if (e.key === 'Tab') { e.preventDefault(); document.execCommand('insertText', false, "\t"); }
        if (e.key === 'Enter') {
            e.preventDefault();
            const lastLine = elIn.value.substring(0, elIn.selectionStart).split('\n').pop();
            const indent = lastLine.match(/^\s*/)[0];
            const extra = lastLine.trim().endsWith(':') ? '\t' : '';
            document.execCommand('insertText', false, '\n' + indent + extra);
        }
    }

    function syncScroll() { elOut.scrollTop = elGutter.scrollTop = elIn.scrollTop; elOut.scrollLeft = elIn.scrollLeft; }
    function toggleSidebar() { 
        document.getElementById('sidebar').classList.toggle('collapsed');
        document.getElementById('open-btn').style.display = document.getElementById('sidebar').classList.contains('collapsed') ? 'block' : 'none';
    }
    function runSimulation() {
        const log = document.getElementById('sim-logs');
        log.innerHTML += `<div>&e[System] Reloading ${curFile}...</div>`;
        setTimeout(() => log.innerHTML += `<div>&a[System] Reload complete.</div>`, 300);
        log.scrollTop = log.scrollHeight;
    }
    function handleSimInput(e) {
        if (e.key === 'Enter') {
            const log = document.getElementById('sim-logs');
            log.innerHTML += `<div>&f&lPlayer: &7${e.target.value}</div>`;
            e.target.value = '';
            log.scrollTop = log.scrollHeight;
        }
    }
    function exportSk() {
        const blob = new Blob([elIn.value], {type:'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = curFile; a.click();
    }
</script>
</body>
</html>
