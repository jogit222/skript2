<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skript IDE - Stable v9</title>
    <style>
        :root {
            --bg: #282a36; --sidebar: #1e1f29; --fg: #f8f8f2;
            --purple: #bd93f9; --selection: #44475a; --comment: #6272a4;
            --cyan: #8be9fd; --pink: #ff79c6; --green: #50fa7b; 
            --orange: #ffb86c; --red: #ff5555; --yellow: #f1fa8c;
            --line-height: 22px;
        }
        
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: 'Inter', sans-serif; overflow: hidden; color: var(--fg); }
        .container { display: flex; height: 100vh; width: 100vw; position: absolute; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid #111; flex-shrink: 0; }
        .sidebar-header { padding: 15px; font-size: 11px; font-weight: bold; color: var(--purple); border-bottom: 1px solid #000; display: flex; justify-content: space-between; align-items: center; }
        .file-list { flex: 1; overflow-y: auto; padding: 5px; }
        .file-item { padding: 8px 10px; cursor: pointer; font-size: 13px; color: #888; border-radius: 4px; margin-bottom: 2px; display: flex; justify-content: space-between; transition: 0.2s; }
        .file-item:hover { background: var(--selection); color: #fff; }
        .file-item.active { background: #353745; color: var(--green); font-weight: bold; }

        /* MAIN */
        .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .toolbar { height: 42px; background: var(--sidebar); display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid #000; gap: 10px; }
        
        /* EDITOR */
        .editor-container { flex: 6; position: relative; display: flex; background: var(--bg); overflow: hidden; }
        #gutter { width: 45px; background: var(--sidebar); color: var(--comment); text-align: right; padding-top: 10px; border-right: 1px solid rgba(255,255,255,0.05); font-family: monospace; font-size: 13px; user-select: none; }
        .line-num { padding-right: 10px; height: var(--line-height); }
        
        .input-area { flex: 1; position: relative; overflow: hidden; }
        #editing, #highlighting { position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 10px; border: 0; tab-size: 4; white-space: pre; word-wrap: normal; box-sizing: border-box; overflow: auto; font-family: 'Fira Code', 'Consolas', monospace; font-size: 14px; line-height: var(--line-height); }
        #editing { z-index: 3; background: transparent; color: transparent; caret-color: #fff; outline: none; resize: none; }
        #highlighting { z-index: 2; pointer-events: none; }

        /* SIMULATOR */
        .sim-container { flex: 4; background: #0c0c0c; display: flex; flex-direction: column; border-top: 2px solid var(--purple); }
        #sim-logs { flex: 1; padding: 12px; overflow-y: auto; font-size: 13px; color: #ddd; font-family: 'Consolas', monospace; }
        .sim-input-wrap { display: flex; background: #000; padding: 10px; border-top: 1px solid #333; }
        #sim-input { flex: 1; background: transparent; border: none; color: #fff; outline: none; padding-left: 10px; font-family: monospace; font-size: 14px; }
        
        /* COLORS & SYNTAX */
        .mc-tag { opacity: 0.4; }
        .mc-0 { color: #000; } .mc-1 { color: #00a; } .mc-2 { color: #0a0; } .mc-3 { color: #0aa; }
        .mc-4 { color: #a00; } .mc-5 { color: #a0a; } .mc-6 { color: #fa0; } .mc-7 { color: #aaa; }
        .mc-8 { color: #555; } .mc-9 { color: #55f; } .mc-a { color: #5f5; } .mc-b { color: #5ff; }
        .mc-c { color: #f55; } .mc-d { color: #f5f; } .mc-e { color: #ff5; } .mc-f { color: #fff; }

        .sk-ev { color: var(--pink); font-weight: bold; }
        .sk-eff { color: var(--cyan); }
        .sk-str { color: #a6e22e; }
        .sk-comment { color: var(--comment); font-style: italic; }

        button.tool { background: var(--selection); color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        button.tool:hover { background: var(--purple); color: #000; }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-header">FILES <button onclick="createNewFile()" style="background:none; border:none; color:var(--green); cursor:pointer;">+</button></div>
        <div class="file-list" id="file-list"></div>
    </div>

    <div class="main">
        <div class="toolbar">
            <span id="cur-filename" style="font-weight:bold; color:var(--purple); font-size:13px;">script.sk</span>
            <div style="flex:1"></div>
            <button class="tool" onclick="parseAndReload()" style="color:var(--green)">▶ RELOAD SCRIPT</button>
            <button class="tool" onclick="saveAll()">SAVE</button>
        </div>

        <div class="editor-container">
            <div id="gutter"></div>
            <div class="input-area">
                <div id="highlighting"></div>
                <textarea id="editing" spellcheck="false" oninput="updateEditor()" onscroll="syncScroll()" onkeydown="handleKeys(event)"></textarea>
            </div>
        </div>

        <div class="sim-container">
            <div id="sim-logs"></div>
            <div class="sim-input-wrap">
                <span style="color:var(--green); font-weight:bold;">&gt;</span>
                <input type="text" id="sim-input" placeholder="Type here...">
                <button class="tool" onclick="processInput()">SEND</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- APP STATE ---
    let files = JSON.parse(localStorage.getItem('sk_stable_v9')) || {
        "main.sk": "function greet(name):\n\tsend \"&eHello &f%_name%&e, welcome back!\"\n\non chat:\n\tif message contains \"lag\":\n\t\tsend \"&cDo not complain about lag!\"\n\t\tcancel event\n\ncommand /hello:\n\ttrigger:\n\t\tgreet(player)\n\t\tbroadcast \"&a%player% joined the party!\""
    };
    let curFile = Object.keys(files)[0];
    let engine = { chat: [], commands: {}, functions: {} };

    function init() {
        renderFileList();
        loadFile(curFile);
        parseAndReload(); // Load script logic
        
        // ROBUST ENTER KEY LISTENER
        document.getElementById('sim-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault();
                processInput();
            }
        });
    }

    // --- INTERPRETER ENGINE ---
    function parseAndReload() {
        engine = { chat: [], commands: {}, functions: {} };
        const lines = files[curFile].split('\n');
        let scope = null;

        lines.forEach(line => {
            let trim = line.trim();
            if (!trim || trim.startsWith('#')) return;

            if (trim.startsWith('on chat:')) { 
                scope = engine.chat; 
            } else if (trim.startsWith('command /')) {
                let name = trim.match(/\/(\w+)/)[1];
                engine.commands[name] = []; 
                scope = engine.commands[name];
            } else if (trim.startsWith('function ')) {
                let match = trim.match(/function (\w+)\((.*)\):/);
                if (match) {
                    engine.functions[match[1]] = { args: match[2].split(','), code: [] };
                    scope = engine.functions[match[1]].code;
                }
            } else if (scope) {
                if (trim !== "trigger:") {
                    // Store the line cleanly (remove tabs for easier execution)
                    scope.push(trim); 
                }
            }
        });
        log("&e[System] Script reloaded.");
    }

    function execute(lines, ctx) {
        if(!lines) return;
        
        for(let i=0; i<lines.length; i++) {
            let raw = lines[i];
            
            // 1. Variable Replacement
            let p = raw.replace(/%player%/g, ctx.player).replace(/%message%/g, ctx.message);
            // Function args (_arg)
            Object.keys(ctx).forEach(k => { 
                if(k.startsWith('_')) p = p.replace(new RegExp(`%${k}%`, 'g'), ctx[k]); 
            });

            // 2. Execution Logic
            try {
                if (p.startsWith('cancel event')) {
                    ctx.cancelled = true;
                } 
                else if (p.startsWith('send ') || p.startsWith('broadcast ')) {
                    // Robust quote extractor: matches text between first and last quote
                    let match = p.match(/"(.*)"/);
                    if(match) log(match[1]); 
                    else log("&c[Script Error] Invalid text format in: " + p);
                } 
                else if (p.startsWith('if ') && p.includes('contains')) {
                    // Check condition
                    let parts = p.match(/"(.*)"/);
                    if(parts && !ctx.message.includes(parts[1])) {
                        return; // Stop this block if condition fails (Simple implementation)
                    }
                } 
                else {
                    // Function Call Check
                    let fMatch = p.match(/^(\w+)\((.*)\)$/);
                    if (fMatch && engine.functions[fMatch[1]]) {
                        let fName = fMatch[1];
                        let fArgs = fMatch[2].split(','); // ["arg1", "arg2"]
                        let fDef = engine.functions[fName];
                        
                        let fCtx = { ...ctx }; // Clone context
                        
                        // Map arguments
                        fDef.args.forEach((argName, index) => {
                            let val = fArgs[index] ? fArgs[index].trim() : "";
                            if(val === "player") val = ctx.player;
                            else val = val.replace(/"/g, ''); // Remove quotes from strings
                            fCtx[`_${argName.trim()}`] = val;
                        });
                        
                        execute(fDef.code, fCtx);
                    }
                }
            } catch(err) {
                log("&c[Internal Error] " + err.message);
            }
        }
    }

    // --- INPUT HANDLER ---
    function processInput() {
        const input = document.getElementById('sim-input');
        const val = input.value; 
        if (!val) return;
        
        if (val.startsWith('/')) {
            // Command Mode
            let cmdParts = val.substring(1).split(' ');
            let cmdName = cmdParts[0];
            if (engine.commands[cmdName]) {
                execute(engine.commands[cmdName], {player: "User", message: val});
            } else {
                log("&fUnknown command.");
            }
        } else {
            // Chat Mode
            let ctx = {player: "User", message: val, cancelled: false};
            execute(engine.chat, ctx); // Run 'on chat' event
            
            if (!ctx.cancelled) {
                log(`&f<User> &7${val}`);
            }
        }
        input.value = '';
    }

    // --- UI HELPERS ---
    function log(msg) {
        const logs = document.getElementById('sim-logs');
        const div = document.createElement('div');
        // Parse Colors
        let html = msg.replace(/&([0-9a-fklmnor])/gi, (m, c) => `<span class="mc-${c.toLowerCase()}">`);
        html = html.replace(/<\/span>/g, '') + "</span>".repeat((msg.match(/&/g) || []).length);
        div.innerHTML = html;
        logs.appendChild(div);
        logs.scrollTop = logs.scrollHeight;
    }

    // --- EDITOR ---
    function updateEditor() {
        const input = document.getElementById('editing');
        const output = document.getElementById('highlighting');
        const code = input.value;
        files[curFile] = code;

        // Line Numbers
        const lines = code.split('\n').length;
        document.getElementById('gutter').innerHTML = Array.from({length: lines}, (_, i) => `<div class="line-num">${i+1}</div>`).join('');

        // Formatting
        let html = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        html = html.replace(/(#.*)/g, '<span class="sk-comment">$1</span>');
        html = html.replace(/("(?:[^"\\]|\\.)*")/g, (m) => {
            let clean = m.replace(/&amp;/g, '&');
            let fmt = clean.replace(/&([0-9a-fklmnor])/gi, (match, c) => `<span class="mc-${c.toLowerCase()}"><span class="mc-tag">&${c}</span>`);
            return `<span class="sk-str">${fmt}${"</span>".repeat((fmt.match(/<span/g)||[]).length)}</span>`;
        });
        
        ["on chat:", "command", "function", "send", "broadcast", "if", "cancel event", "trigger:"].forEach(kw => {
            let pattern = new RegExp(`\\b${kw.replace(':', '')}:?\\b`, 'g');
            html = html.replace(pattern, `<span class="sk-ev">${kw}</span>`);
        });

        output.innerHTML = html + (code.endsWith('\n') ? ' ' : '');
        syncScroll();
    }

    function syncScroll() {
        const edit = document.getElementById('editing');
        const high = document.getElementById('highlighting');
        const gut = document.getElementById('gutter');
        high.scrollTop = gut.scrollTop = edit.scrollTop;
        high.scrollLeft = edit.scrollLeft;
    }

    function handleKeys(e) { if (e.key === 'Tab') { e.preventDefault(); document.execCommand('insertText', false, '\t'); } }

    // --- FILE SYSTEM ---
    function renderFileList() {
        document.getElementById('file-list').innerHTML = Object.keys(files).map(f => `
            <div class="file-item ${f === curFile ? 'active' : ''}" onclick="loadFile('${f}')">
                <span>${f}</span>
                <span style="color:#f55; font-weight:bold;" onclick="deleteFile('${f}', event)">×</span>
            </div>`).join('');
    }
    function loadFile(f) { curFile = f; document.getElementById('editing').value = files[f]; document.getElementById('cur-filename').innerText = f; updateEditor(); renderFileList(); }
    function createNewFile() { let n = prompt("Filename:"); if(n){ files[n]=""; loadFile(n); saveAll(); } }
    function deleteFile(f, e) { e.stopPropagation(); if(confirm("Del?")){ delete files[f]; if(!Object.keys(files).length) files["script.sk"]=""; loadFile(Object.keys(files)[0]); saveAll(); } }
    function saveAll() { localStorage.setItem('sk_stable_v9', JSON.stringify(files)); }

    init();
</script>
</body>
</html>
