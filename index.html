<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skript IDE - High Performance</title>
    <style>
        :root {
            --bg: #282a36; --sidebar: #1e1f29; --fg: #f8f8f2;
            --purple: #bd93f9; --selection: #44475a; --comment: #6272a4;
            --cyan: #8be9fd; --pink: #ff79c6; --green: #50fa7b; 
            --orange: #ffb86c; --red: #ff5555; --yellow: #f1fa8c;
            --line-height: 22px;
        }
        
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: 'Inter', sans-serif; overflow: hidden; color: var(--fg); }
        .container { display: flex; height: 100vh; width: 100vw; }
        
        /* Sidebar */
        .sidebar { width: 240px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid #111; z-index: 10; transition: width 0.2s ease; }
        .sidebar.collapsed { width: 0; overflow: hidden; border: none; }
        .sidebar-header { padding: 15px; font-size: 13px; font-weight: bold; color: var(--purple); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        
        .project-list { flex: 1; padding: 5px; overflow-y: auto; }
        .project-item { padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; margin-bottom: 2px; display: flex; justify-content: space-between; align-items: center; white-space: nowrap; }
        .project-item:hover { background: var(--selection); }
        .project-item.active { background: var(--purple); color: #000; font-weight: bold; }
        
        /* Main */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; }
        .toolbar { height: 40px; background: var(--sidebar); display: flex; align-items: center; padding: 0 10px; border-bottom: 1px solid #111; gap: 10px; }
        .tool-btn { background: var(--selection); border: 1px solid rgba(255,255,255,0.1); color: var(--fg); padding: 4px 10px; border-radius: 3px; cursor: pointer; font-size: 11px; }
        .btn-green { color: var(--green); }
        .toggle-side { background: transparent; border: none; color: var(--comment); cursor: pointer; font-size: 18px; display: flex; align-items: center; }

        /* Editor Engine */
        .editor-container { flex: 1; position: relative; display: flex; background: var(--bg); overflow: hidden; }
        .code-font { font-family: 'Fira Code', 'Consolas', monospace; font-size: 14px; line-height: var(--line-height); }
        #gutter { width: 45px; background: var(--sidebar); color: var(--comment); text-align: right; padding-top: 10px; user-select: none; border-right: 1px solid rgba(255,255,255,0.05); overflow: hidden; }
        .line-num { padding-right: 10px; height: var(--line-height); }
        
        .input-area { flex: 1; position: relative; overflow: hidden; }
        #editing, #highlighting { position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 10px; border: 0; tab-size: 4; white-space: pre; word-wrap: normal; box-sizing: border-box; overflow: auto; }
        #editing { z-index: 3; background: transparent; color: transparent; caret-color: #fff; outline: none; resize: none; }
        #highlighting { z-index: 2; pointer-events: none; white-space: pre; }

        /* Syntax: Fixed Colors */
        .sk-event { color: var(--pink); font-weight: bold; }
        .sk-effect { color: var(--cyan); }
        .sk-var { color: var(--orange); }
        .sk-comment { color: var(--comment); font-style: italic; }
        .sk-string { color: var(--green); }
        .sk-cond { color: var(--yellow); font-weight: bold; }
        .sk-item { color: var(--purple); }

        /* Autocomplete */
        #autocomplete { position: absolute; display: none; background: var(--sidebar); border: 1px solid var(--purple); border-radius: 4px; z-index: 5000; max-height: 200px; overflow-y: auto; min-width: 250px; box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
        .suggest-item { padding: 6px 12px; cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .suggest-item.active { background: var(--purple); color: #000; }
        
        .status-bar { height: 22px; background: var(--sidebar); border-top: 1px solid #111; display: flex; align-items: center; padding: 0 10px; font-size: 10px; color: var(--comment); justify-content: space-between; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="autocomplete"></div>

<div id="auth-modal" class="modal-overlay" style="display:flex;">
    <div style="background:var(--sidebar); padding:25px; border-radius:8px; border:1px solid var(--purple); width:300px;">
        <h3 style="margin:0 0 15px 0; color:var(--purple)">Skript IDE Pro</h3>
        <input type="text" id="auth-user" style="width:100%; padding:10px; background:#111; border:1px solid #333; color:white; margin-bottom:15px; box-sizing:border-box;" placeholder="Username">
        <button class="tool-btn" style="width:100%; height:40px; background:var(--purple); color:black;" onclick="handleAuth()">LOGIN</button>
    </div>
</div>

<div class="container">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span>EXPLORER</span>
            <button class="toggle-side" onclick="toggleSidebar()">Â«</button>
        </div>
        <div style="padding: 10px; display: flex; gap: 5px;">
            <button class="tool-btn" style="flex:1" onclick="createNewProject()">+ NEW</button>
            <button class="tool-btn" style="flex:1" onclick="document.getElementById('file-input').click()">OPEN</button>
        </div>
        <div class="project-list" id="project-list"></div>
    </div>

    <div class="main">
        <div class="toolbar">
            <button class="toggle-side" id="open-btn" style="display:none" onclick="toggleSidebar()">Â»</button>
            <span id="current-filename" style="font-size: 12px; color: var(--purple); font-weight: bold;">script.sk</span>
            <div style="flex:1"></div>
            <button class="tool-btn" onclick="runCheck()">DIAGNOSTIC</button>
            <button class="tool-btn" onclick="exportFile()">EXPORT</button>
            <button class="tool-btn btn-green" onclick="save(false)">SAVE</button>
        </div>

        <div class="editor-container">
            <div id="gutter" class="code-font"></div>
            <div class="input-area">
                <div id="highlighting" class="code-font"></div>
                <textarea id="editing" class="code-font" spellcheck="false" oninput="onInput()" onscroll="syncScroll()" onkeydown="onKey(event)"></textarea>
            </div>
        </div>

        <div class="status-bar">
            <span id="save-status">Ready</span>
            <span id="cursor-pos">Ln 1, Col 1</span>
        </div>
    </div>
</div>

<input type="file" id="file-input" style="display:none" onchange="importFile(this)">

<script>
    const elInput = document.getElementById('editing');
    const elOutput = document.getElementById('highlighting');
    const elGutter = document.getElementById('gutter');
    const elSuggest = document.getElementById('autocomplete');
    
    let user = null;
    let currentFile = null;
    let data = JSON.parse(localStorage.getItem('sk_pro_data')) || {};
    let filtered = [];
    let selIdx = 0;

    // --- REBUILT PERFORMANCE DICTIONARY ---
    const effects = ["set", "add", "remove", "delete", "send", "broadcast", "wait", "stop", "cancel event", "teleport", "kill", "spawn", "give", "apply"];
    const conditions = ["if", "else", "else if", "has permission", "exists", "is set", "is online"];
    const events = ["on join:", "on quit:", "on chat:", "on death:", "on break:", "on place:", "on load:", "on rightclick:", "on leftclick:", "on command:"];
    
    // Autocomplete dictionary
    const allWords = [];
    effects.forEach(w => allWords.push({t:w, c:'eff'}));
    conditions.forEach(w => allWords.push({t:w, c:'cond'}));
    events.forEach(w => allWords.push({t:w, c:'ev'}));

    // --- LOGIC ---
    function handleAuth() {
        const u = document.getElementById('auth-user').value.trim();
        if(!u) return; user = u;
        if(!data[user]) data[user] = { "Main.sk": "on join:\n\tsend \"&aHello!\"" };
        document.getElementById('auth-modal').style.display = 'none';
        renderList(); load(Object.keys(data[user])[0]);
    }

    function toggleSidebar() {
        const s = document.getElementById('sidebar');
        const b = document.getElementById('open-btn');
        s.classList.toggle('collapsed');
        b.style.display = s.classList.contains('collapsed') ? 'flex' : 'none';
    }

    function renderList() {
        document.getElementById('project-list').innerHTML = Object.keys(data[user]).map(f => `
            <div class="project-item ${currentFile === f ? 'active' : ''}" onclick="load('${f}')">ðŸ“„ ${f}</div>
        `).join('');
    }

    function load(f) {
        currentFile = f; elInput.value = data[user][f];
        document.getElementById('current-filename').innerText = f;
        update(); renderList();
    }

    function save(silent=true) {
        if(!user) return; data[user][currentFile] = elInput.value;
        localStorage.setItem('sk_pro_data', JSON.stringify(data));
        document.getElementById('save-status').innerText = "Saved";
        if(!silent) alert("Saved!");
    }

    function update() {
        let code = elInput.value;
        // Gutter
        const lines = code.split('\n');
        elGutter.innerHTML = lines.map((_, i) => `<div class="line-num">${i+1}</div>`).join('');
        
        // Highlighting Logic (Fixed Order)
        let html = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        
        // 1. Comments
        html = html.replace(/(#.*)/g, '<span class="sk-comment">$1</span>');
        // 2. Strings
        html = html.replace(/("(?:[^"\\]|\\.)*")/g, '<span class="sk-string">$1</span>');
        // 3. Variables
        html = html.replace(/(\{.*?\})/g, '<span class="sk-var">$1</span>');
        // 4. Events / Command Headers
        html = html.replace(/^(on\s+.*:|command\s+.*:)/gm, '<span class="sk-event">$1</span>');
        
        // 5. Effects & Conditions (Keyword matching)
        effects.forEach(k => { html = html.replace(new RegExp(`\\b${k}\\b`, 'g'), `<span class="sk-effect">${k}</span>`); });
        conditions.forEach(k => { html = html.replace(new RegExp(`\\b${k}\\b`, 'g'), `<span class="sk-cond">${k}</span>`); });

        elOutput.innerHTML = html + (code.endsWith('\n') ? ' ' : '');
        
        const cur = elInput.value.substr(0, elInput.selectionStart).split("\n");
        document.getElementById('cursor-pos').innerText = `Ln ${cur.length}, Col ${cur[cur.length-1].length + 1}`;
    }

    function onInput() {
        update();
        document.getElementById('save-status').innerText = "Editing...";
        const val = elInput.value;
        const pos = elInput.selectionStart;
        const lastWord = val.substring(0, pos).split(/[\s\t\n]+/).pop();

        if (lastWord.length >= 2) {
            filtered = allWords.filter(w => w.t.includes(lastWord.toLowerCase())).slice(0, 10);
            if (filtered.length > 0) {
                selIdx = 0; showSuggest(pos); return;
            }
        }
        elSuggest.style.display = 'none';
    }

    function showSuggest(pos) {
        const lines = elInput.value.substring(0, pos).split('\n');
        elSuggest.style.display = 'block';
        elSuggest.style.top = (lines.length * 22 + 45) + 'px';
        elSuggest.style.left = (lines[lines.length-1].length * 8 + 50) + 'px';
        elSuggest.innerHTML = filtered.map((s, i) => `
            <div class="suggest-item ${i === selIdx ? 'active' : ''}" onclick="applySuggest('${s.t}')">
                ${s.t} <small style="opacity:0.5">${s.c}</small>
            </div>
        `).join('');
    }

    function applySuggest(word) {
        const pos = elInput.selectionStart;
        const val = elInput.value;
        const lastPart = val.substring(0, pos).split(/[\s\t\n]+/).pop();
        elInput.value = val.substring(0, pos - lastPart.length) + word + val.substring(pos);
        elSuggest.style.display = 'none';
        update();
    }

    function onKey(e) {
        if (elSuggest.style.display === 'block') {
            if (e.key === 'ArrowDown') { e.preventDefault(); selIdx = (selIdx + 1) % filtered.length; showSuggest(elInput.selectionStart); return; }
            if (e.key === 'ArrowUp') { e.preventDefault(); selIdx = (selIdx - 1 + filtered.length) % filtered.length; showSuggest(elInput.selectionStart); return; }
            if (e.key === 'Enter' || e.key === 'Tab') { e.preventDefault(); applySuggest(filtered[selIdx].t); return; }
        }
        if (e.key === 'Tab') { e.preventDefault(); document.execCommand('insertText', false, "\t"); }
        if (e.key === 'Enter') {
            e.preventDefault();
            const lastLine = elInput.value.substring(0, elInput.selectionStart).split('\n').pop();
            const indent = lastLine.match(/^\s*/)[0];
            const extra = lastLine.trim().endsWith(':') ? '\t' : '';
            document.execCommand('insertText', false, '\n' + indent + extra);
        }
    }

    function syncScroll() {
        elOutput.scrollTop = elInput.scrollTop;
        elOutput.scrollLeft = elInput.scrollLeft;
        elGutter.scrollTop = elInput.scrollTop;
    }

    function exportFile() {
        const b = new Blob([elInput.value], {type:'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = currentFile; a.click();
    }

    function createNewProject() {
        const n = prompt("File name:");
        if(n) { if(!n.endsWith(".sk")) n+=".sk"; data[user][n] = "# New Script"; load(n); }
    }

    function importFile(input) {
        const f = input.files[0];
        const r = new FileReader();
        r.onload = (e) => { data[user][f.name] = e.target.result; load(f.name); };
        r.readAsText(f);
    }

    function runCheck() {
        const errs = (elInput.value.match(/:[ \t]*\n(?![\t ]+)/g) || []).length;
        alert(errs > 0 ? `Found ${errs} indentation errors after colons.` : "Basic structure looks good!");
    }
</script>
</body>
</html>
