<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skript IDE Pro - Complete</title>
    <style>
        :root {
            --bg: #282a36; --sidebar: #21222c; --fg: #f8f8f2;
            --purple: #bd93f9; --selection: #44475a; --comment: #6272a4;
            --cyan: #8be9fd; --pink: #ff79c6; --green: #50fa7b; 
            --orange: #ffb86c; --red: #ff5555; --yellow: #f1fa8c;
            --line-height: 24px;
        }
        
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: 'Segoe UI', sans-serif; overflow: hidden; color: var(--fg); }
        .container { display: flex; height: 100vh; width: 100vw; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.1); z-index: 10; }
        .sidebar-brand { padding: 20px; font-size: 18px; font-weight: bold; color: var(--purple); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .project-list { flex: 1; padding: 10px; overflow-y: auto; }
        .project-item { padding: 10px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-bottom: 5px; display: flex; justify-content: space-between; transition: 0.2s; }
        .project-item:hover { background: var(--selection); }
        .project-item.active { background: var(--purple); color: white; }
        
        /* Main UI */
        .main { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        .toolbar { height: 50px; background: var(--sidebar); display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid rgba(255,255,255,0.1); justify-content: space-between; }
        .tool-btn { background: var(--selection); border: 1px solid rgba(255,255,255,0.1); color: var(--fg); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; transition: 0.2s; }
        .btn-green { color: var(--green); border-color: var(--green); }
        .btn-yellow { color: var(--yellow); border-color: var(--yellow); }
        .status-bar { height: 25px; background: var(--sidebar); border-top: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; padding: 0 10px; font-size: 11px; color: var(--comment); justify-content: space-between;}
        
        /* Editor */
        .editor-container { flex: 1; position: relative; display: flex; overflow: hidden; }
        .code-font { font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 14px; line-height: var(--line-height); }
        #gutter { width: 45px; background: var(--sidebar); color: var(--comment); text-align: right; border-right: 1px solid rgba(255,255,255,0.1); user-select: none; padding-top: 15px; }
        .line-number { height: var(--line-height); padding-right: 8px; }
        .input-area { flex: 1; position: relative; overflow: hidden; }
        #editing, #highlighting { position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 15px; border: 0; tab-size: 4; white-space: pre; word-wrap: normal; box-sizing: border-box; }
        #editing { z-index: 3; background: transparent; color: transparent; caret-color: var(--fg); outline: none; resize: none; overflow: auto; }
        #highlighting { z-index: 2; pointer-events: none; overflow: hidden; }

        /* Autocomplete */
        #autocomplete { position: absolute; display: none; background: var(--sidebar); border: 1px solid var(--purple); border-radius: 4px; z-index: 5000; max-height: 250px; overflow-y: auto; min-width: 220px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .suggest-item { padding: 8px 12px; cursor: pointer; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; }
        .suggest-item.active { background: var(--purple); color: white; }
        .suggest-type { opacity: 0.5; font-size: 9px; text-transform: uppercase; border: 1px solid; padding: 1px 4px; border-radius: 3px; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 6000; align-items: center; justify-content: center; }
        .modal { background: var(--sidebar); padding: 30px; border-radius: 12px; width: 450px; border: 1px solid var(--purple); }
        .input-field { width: 100%; background: var(--bg); border: 1px solid #444; color: #fff; padding: 12px; border-radius: 6px; margin-bottom: 15px; box-sizing: border-box; }
        .error-item { background: rgba(255, 85, 85, 0.1); border-left: 3px solid var(--red); padding: 10px; margin-bottom: 8px; font-size: 12px; }

        /* Colors */
        .sk-event { color: var(--pink); font-weight: bold; }
        .sk-effect { color: var(--cyan); }
        .sk-var { color: var(--orange); }
        .sk-comment { color: var(--comment); font-style: italic; }
        .sk-string { color: var(--green); }
        .sk-cond { color: var(--yellow); }
    </style>
</head>
<body>

<input type="file" id="file-input" style="display: none;" onchange="processFileImport(this)">
<div id="autocomplete"></div>

<div id="auth-modal" class="modal-overlay" style="display:flex;">
    <div class="modal" style="width: 320px;">
        <h2 style="color:var(--purple); margin-top:0;">Skript IDE <small>PRO</small></h2>
        <input type="text" id="auth-user" class="input-field" placeholder="Username">
        <button class="tool-btn" style="width:100%; padding:12px; background:var(--purple); color:white; border:none;" onclick="handleAuth()">LOGIN / JOIN</button>
    </div>
</div>

<div id="diag-modal" class="modal-overlay">
    <div class="modal">
        <h2 style="margin:0;">Diagnostics</h2>
        <div id="diag-results" style="margin-top:20px; max-height:300px; overflow-y:auto;"></div>
        <button class="tool-btn" style="width:100%; margin-top:15px;" onclick="document.getElementById('diag-modal').style.display='none'">CLOSE</button>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-brand">Skript IDE <small style="opacity: 0.5;">PRO</small></div>
        <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05);">
            <div id="user-display" style="font-size: 11px; color: var(--cyan); margin-bottom: 10px;">User: Guest</div>
            <div style="display:flex; gap:5px;">
                <button class="tool-btn" style="flex:1" onclick="createNewProject()">+ NEW</button>
                <button class="tool-btn" style="flex:1" onclick="document.getElementById('file-input').click()">üìÇ OPEN</button>
            </div>
        </div>
        <div class="project-list" id="project-list"></div>
        <div style="padding: 15px;"><button class="tool-btn" style="width:100%" onclick="location.reload()">LOGOUT</button></div>
    </div>

    <div class="main">
        <div class="toolbar">
            <span id="current-filename" style="color: var(--purple); font-weight: bold;">No file</span>
            <div style="display:flex; gap:10px;">
                <button class="tool-btn btn-yellow" onclick="runSyntaxCheck()">‚ö†Ô∏è CHECK</button>
                <button class="tool-btn" onclick="downloadCode()">‚¨áÔ∏è EXPORT</button>
                <button class="tool-btn btn-green" onclick="saveCurrentProject(false)">üíæ SAVE</button>
            </div>
        </div>
        
        <div class="editor-container">
            <div id="gutter" class="code-font"></div>
            <div class="input-area">
                <pre id="highlighting" class="code-font"></pre>
                <textarea id="editing" class="code-font" spellcheck="false" oninput="onEditorInput()" onscroll="syncScroll()" onkeydown="handleKeydown(event)"></textarea>
            </div>
        </div>

        <div class="status-bar">
            <span id="save-status">Ready</span>
            <span id="cursor-pos">Ln 1, Col 1</span>
        </div>
    </div>
</div>

<script>
    const elInput = document.getElementById('editing');
    const elOutput = document.getElementById('highlighting');
    const elGutter = document.getElementById('gutter');
    const elSuggest = document.getElementById('autocomplete');
    const elSaveStatus = document.getElementById('save-status');

    let currentUser = null;
    let currentProjectId = null;
    let users = JSON.parse(localStorage.getItem('sk_users')) || {};
    let filteredSuggestions = [];
    let currentSuggestIndex = 0;
    let saveTimer;

    // --- MEGA DATABASE (Pure Skript) ---
    const syntaxDB = {
        events: ["on join:", "on quit:", "on chat:", "on command:", "on death:", "on damage:", "on break:", "on place:", "on rightclick:", "on leftclick:", "on load:", "on skript load:", "on connect:", "on respawn:", "on pick up:", "on drop:", "on inventory click:", "on consume:", "on portal:", "on move:", "on world change:", "on pressure plate:", "on ignite:", "on explode:", "on weather change:", "on lightning strike:"],
        effects: ["set", "add", "remove", "delete", "clear", "send", "broadcast", "message", "wait", "stop", "cancel event", "teleport", "kill", "heal", "feed", "damage", "strike lightning", "give", "drop", "spawn", "apply", "remove effect", "play sound", "play effect", "open inventory", "close inventory", "kick", "ban", "execute console command", "make player execute", "push", "launch", "ignite", "create hologram", "set metadata"],
        conditions: ["if", "else", "else if", "while", "loop", "has permission", "is holding", "is sneaking", "is sprinting", "is flying", "is alive", "is dead", "is blocking", "is op", "exists", "is set", "contains", "is greater than", "is less than", "is between"],
        expressions: ["player", "victim", "attacker", "event-block", "event-location", "event-item", "event-world", "loop-player", "loop-value", "now", "today", "unix timestamp", "health of", "name of", "uuid of", "metadata value", "location of", "distance between", "velocity of", "gamemode of", "inventory of", "balance of", "random player", "all players"],
        materials: ["stone", "grass block", "dirt", "cobblestone", "oak planks", "bedrock", "water", "lava", "sand", "iron ore", "diamond block", "tnt", "obsidian", "torch", "chest", "crafting table", "furnace", "diamond sword", "iron pickaxe", "golden apple", "elytra", "netherite ingot", "ender pearl", "totem of undying"]
    };

    const allKeywords = [];
    Object.keys(syntaxDB).forEach(type => {
        syntaxDB[type].forEach(word => allKeywords.push({text: word, type: type}));
    });

    // --- KEYBOARD & AUTOCOMPLETE ---
    function handleKeydown(e) {
        const start = elInput.selectionStart;
        const val = elInput.value;

        if (elSuggest.style.display === 'block') {
            if (e.key === 'ArrowDown') { e.preventDefault(); currentSuggestIndex = (currentSuggestIndex + 1) % filteredSuggestions.length; renderSuggestions(); return; }
            if (e.key === 'ArrowUp') { e.preventDefault(); currentSuggestIndex = (currentSuggestIndex - 1 + filteredSuggestions.length) % filteredSuggestions.length; renderSuggestions(); return; }
            if (e.key === 'Enter' || e.key === 'Tab') { e.preventDefault(); applySuggestion(filteredSuggestions[currentSuggestIndex].text); return; }
            if (e.key === 'Escape') { closeSuggest(); return; }
        }

        if (e.key === 'Tab') {
            e.preventDefault();
            if (e.shiftKey) {
                const lineStart = val.lastIndexOf('\n', start - 1) + 1;
                if (val.substring(lineStart, lineStart + 1) === '\t') {
                    elInput.value = val.substring(0, lineStart) + val.substring(lineStart + 1);
                    elInput.selectionStart = elInput.selectionEnd = start - 1;
                }
            } else { document.execCommand('insertText', false, "\t"); }
            onEditorInput();
        }

        if (e.key === 'Enter') {
            e.preventDefault();
            const lastLine = val.substring(0, start).split('\n').pop();
            const indent = lastLine.match(/^\s*/)[0];
            const extra = lastLine.trim().endsWith(':') ? '\t' : '';
            document.execCommand('insertText', false, '\n' + indent + extra);
            onEditorInput();
        }

        const pairs = {'{':'}', '[':']', '(':')', '"':'"', "'":"'"};
        if (pairs[e.key]) {
            e.preventDefault();
            document.execCommand('insertText', false, e.key + pairs[e.key]);
            elInput.selectionStart = elInput.selectionEnd = start + 1;
            onEditorInput();
        }
    }

    function onEditorInput() {
        updateEditor();
        elSaveStatus.innerText = "Unsaved changes..."; elSaveStatus.style.color = "var(--orange)";
        clearTimeout(saveTimer);
        saveTimer = setTimeout(() => saveCurrentProject(true), 2000);

        const val = elInput.value;
        const pos = elInput.selectionStart;
        const currentWord = val.substring(0, pos).split(/[\s\t\n]+/).pop();

        if (currentWord.length >= 2) {
            filteredSuggestions = allKeywords.filter(k => k.text.toLowerCase().includes(currentWord.toLowerCase()))
                                             .sort((a,b) => a.text.startsWith(currentWord) ? -1 : 1).slice(0, 15);
            if (filteredSuggestions.length > 0) {
                currentSuggestIndex = 0;
                renderSuggestions();
                const lines = val.substring(0, pos).split('\n');
                elSuggest.style.top = (lines.length * 24 + 20) + "px";
                elSuggest.style.left = (lines[lines.length-1].length * 8 + 40) + "px";
                elSuggest.style.display = 'block';
                return;
            }
        }
        closeSuggest();
    }

    function renderSuggestions() {
        elSuggest.innerHTML = filteredSuggestions.map((s, i) => `
            <div class="suggest-item ${i === currentSuggestIndex ? 'active' : ''}" onclick="applySuggestion('${s.text}')">
                <span>${s.text}</span><span class="suggest-type">${s.type}</span>
            </div>
        `).join('');
    }

    function applySuggestion(word) {
        const pos = elInput.selectionStart;
        const val = elInput.value;
        const lastPart = val.substring(0, pos).split(/[\s\t\n]+/).pop();
        const start = pos - lastPart.length;
        elInput.value = val.substring(0, start) + word + val.substring(pos);
        elInput.selectionStart = elInput.selectionEnd = start + word.length;
        closeSuggest(); updateEditor();
    }
    function closeSuggest() { elSuggest.style.display = 'none'; }

    // --- RENDERING ---
    function updateEditor() {
        let code = elInput.value;
        elGutter.innerHTML = code.split('\n').map((_, i) => `<div class="line-number">${i+1}</div>`).join('');
        let h = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        h = h.replace(/("(?:[^"\\]|\\.)*")/g, '<span class="sk-string">$1</span>');
        h = h.replace(/(#.*)/g, '<span class="sk-comment">$1</span>');
        h = h.replace(/(\{.*?\})/g, '<span class="sk-var">$1</span>');
        h = h.replace(/^(on\s+.*:)/gm, '<span class="sk-event">$1</span>');
        
        syntaxDB.effects.forEach(k => h = h.replace(new RegExp(`\\b${k}\\b`, 'g'), `<span class="sk-effect">${k}</span>`));
        syntaxDB.conditions.forEach(k => h = h.replace(new RegExp(`\\b${k}\\b`, 'g'), `<span class="sk-cond">${k}</span>`));

        elOutput.innerHTML = h + (code.endsWith('\n') ? ' ' : '');
        const lines = elInput.value.substr(0, elInput.selectionStart).split("\n");
        document.getElementById('cursor-pos').innerText = `Ln ${lines.length}, Col ${lines[lines.length-1].length + 1}`;
    }

    // --- LOGIC & MODALS ---
    function handleAuth() {
        const u = document.getElementById('auth-user').value.trim();
        if(!u) return;
        if(!users[u]) users[u] = { projects: {"Main.sk": "on join:\n\tsend \"Welcome!\""} };
        currentUser = u; saveUsers();
        document.getElementById('auth-modal').style.display = 'none';
        document.getElementById('user-display').innerText = "User: " + u;
        renderProjectList(); loadProject("Main.sk");
    }

    function runSyntaxCheck() {
        const lines = elInput.value.split('\n');
        const errs = [];
        lines.forEach((l, i) => {
            if ((l.trim().startsWith("on ") || l.trim().startsWith("command ")) && !l.trim().endsWith(":")) errs.push(`Line ${i+1}: Missing colon ':' at header.`);
        });
        document.getElementById('diag-results').innerHTML = errs.length ? errs.map(e => `<div class="error-item">${e}</div>`).join('') : '<div style="color:var(--green)">Clean!</div>';
        document.getElementById('diag-modal').style.display = 'flex';
    }

    function saveUsers() { localStorage.setItem('sk_users', JSON.stringify(users)); }
    function renderProjectList() {
        document.getElementById('project-list').innerHTML = Object.keys(users[currentUser].projects).map(p => `
            <div class="project-item ${currentProjectId === p ? 'active' : ''}" onclick="loadProject('${p}')">üìÑ ${p}</div>
        `).join('');
    }
    function loadProject(p) { currentProjectId = p; elInput.value = users[currentUser].projects[p]; updateEditor(); document.getElementById('current-filename').innerText = p; renderProjectList(); }
    function saveCurrentProject(silent) { 
        if(!currentUser) return;
        users[currentUser].projects[currentProjectId] = elInput.value; saveUsers(); 
        elSaveStatus.innerText = "Saved"; elSaveStatus.style.color = "var(--green)";
        if(!silent) alert("Saved!");
    }
    function createNewProject() { const n = prompt("Name:"); if(n) { users[currentUser].projects[n] = "# New"; saveUsers(); loadProject(n); } }
    function processFileImport(input) { const f = input.files[0]; const r = new FileReader(); r.onload = (e) => { users[currentUser].projects[f.name] = e.target.result; saveUsers(); loadProject(f.name); }; r.readAsText(f); }
    function downloadCode() { const blob = new Blob([elInput.value], {type:'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = currentProjectId; a.click(); }
    function syncScroll() { elOutput.scrollTop = elGutter.scrollTop = elInput.scrollTop; elOutput.scrollLeft = elInput.scrollLeft; }
</script>
</body>
</html>
