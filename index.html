<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skript IDE Pro - Autocomplete</title>
    <style>
        :root {
            --bg: #282a36; --sidebar: #21222c; --fg: #f8f8f2;
            --purple: #bd93f9; --selection: #44475a; --comment: #6272a4;
            --cyan: #8be9fd; --pink: #ff79c6; --green: #50fa7b; 
            --orange: #ffb86c; --red: #ff5555; --yellow: #f1fa8c;
            --blue: #61afef; --gui-gold: #e5c07b;
            --line-height: 24px;
        }
        
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: 'Segoe UI', sans-serif; overflow: hidden; color: var(--fg); }
        .container { display: flex; height: 100vh; width: 100vw; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid rgba(255,255,255,0.1); z-index: 10; display:flex; flex-direction:column; }
        .sidebar-brand { padding: 20px; font-size: 18px; font-weight: bold; color: var(--purple); }
        .project-list { flex: 1; padding: 10px; overflow-y: auto; }
        .project-item { padding: 10px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-bottom: 5px; transition: 0.2s; }
        .project-item:hover { background: var(--selection); }
        .project-item.active { background: var(--purple); color: white; }

        /* Main Editor */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; }
        .toolbar { height: 50px; background: var(--sidebar); display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid rgba(255,255,255,0.1); justify-content: space-between; }
        .tool-btn { background: var(--selection); border: 1px solid rgba(255,255,255,0.1); color: var(--fg); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; }
        
        .editor-container { flex: 1; position: relative; display: flex; overflow: hidden; }
        .code-font { font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 14px; line-height: var(--line-height); }

        #gutter { width: 45px; background: var(--sidebar); color: var(--comment); text-align: right; border-right: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .line-number { height: var(--line-height); padding-right: 8px; }
        
        .input-area { flex: 1; position: relative; overflow: hidden; }
        #editing, #highlighting { position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 15px; border: 0; tab-size: 4; white-space: pre; word-wrap: normal; box-sizing: border-box; }
        #editing { z-index: 3; background: transparent; color: transparent; caret-color: var(--fg); outline: none; resize: none; overflow: auto; }
        #highlighting { z-index: 2; pointer-events: none; color: var(--fg); }

        /* Autocomplete Box */
        #autocomplete {
            position: absolute; display: none; background: var(--sidebar); 
            border: 1px solid var(--purple); border-radius: 4px; z-index: 5000;
            max-height: 200px; overflow-y: auto; min-width: 180px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .suggest-item { padding: 8px 12px; cursor: pointer; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .suggest-item:hover, .suggest-item.active { background: var(--purple); color: white; }
        .suggest-type { float: right; opacity: 0.5; font-size: 10px; margin-top: 2px; }

        /* Syntax Highlight Classes */
        .sk-event { color: var(--pink); font-weight: bold; }
        .sk-effect { color: var(--cyan); }
        .sk-var { color: var(--orange); }
        .sk-comment { color: var(--comment); font-style: italic; }
        .sk-string { color: var(--green); }
        .sk-reflect-key { color: var(--purple); font-weight: bold; }
        .sk-java-class { color: var(--cyan); text-decoration: underline rgba(139, 233, 253, 0.3); }
        .sk-java-method { color: var(--yellow); }
    </style>
</head>
<body>

<div id="autocomplete"></div>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-brand">Skript IDE <small style="opacity:0.5">PRO</small></div>
        <div class="project-list" id="project-list"></div>
        <div style="padding:15px;"><button class="tool-btn" style="width:100%" onclick="createNewProject()">+ NEW FILE</button></div>
    </div>

    <div class="main">
        <div class="toolbar">
            <span id="current-filename" style="color:var(--purple); font-weight:bold">Untitled.sk</span>
            <div style="display:flex; gap:10px;">
                <button class="tool-btn" onclick="saveCurrentProject()">SAVE</button>
            </div>
        </div>
        
        <div class="editor-container">
            <div id="gutter" class="code-font"></div>
            <div class="input-area">
                <pre id="highlighting" class="code-font"></pre>
                <textarea id="editing" class="code-font" spellcheck="false" oninput="onEditorInput()" onscroll="syncScroll()" onkeydown="handleKeydown(event)"></textarea>
            </div>
        </div>
    </div>
</div>

<script>
    const elInput = document.getElementById('editing');
    const elOutput = document.getElementById('highlighting');
    const elGutter = document.getElementById('gutter');
    const elSuggest = document.getElementById('autocomplete');

    let currentSuggestIndex = 0;
    let filteredSuggestions = [];

    const syntaxDB = {
        core: ["command", "trigger", "function", "variables", "options", "if", "else", "loop", "while", "return", "send", "broadcast", "set", "add", "remove", "delete", "cancel event", "wait", "stop"],
        reflect: ["import", "new", "proxy", "handle", "custom event", "expression", "matched", "invoke", "section", "getter", "setter"],
        java: ["System", "String", "Bukkit", "Player", "ItemStack", "Material", "Location", "Vector", "Event", "Component"]
    };

    // --- KEYDOWN HANDLER (Tabs + Autocomplete Nav) ---
    function handleKeydown(e) {
        const start = elInput.selectionStart;
        const end = elInput.selectionEnd;
        const val = elInput.value;

        // 1. Autocomplete Navigation
        if (elSuggest.style.display === 'block') {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentSuggestIndex = (currentSuggestIndex + 1) % filteredSuggestions.length;
                renderSuggestions();
                return;
            }
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentSuggestIndex = (currentSuggestIndex - 1 + filteredSuggestions.length) % filteredSuggestions.length;
                renderSuggestions();
                return;
            }
            if (e.key === 'Enter' || e.key === 'Tab') {
                e.preventDefault();
                applySuggestion(filteredSuggestions[currentSuggestIndex]);
                return;
            }
            if (e.key === 'Escape') {
                closeSuggest();
                return;
            }
        }

        // 2. Advanced Tab Logic (Multi-line & Shift-Tab)
        if (e.key === 'Tab') {
            e.preventDefault();
            if (e.shiftKey) {
                // Back-tab
                const beforeCaret = val.substring(0, start);
                const lineStart = beforeCaret.lastIndexOf('\n') + 1;
                if (val.substring(lineStart, lineStart + 1) === '\t') {
                    elInput.value = val.substring(0, lineStart) + val.substring(lineStart + 1);
                    elInput.selectionStart = elInput.selectionEnd = start - 1;
                }
            } else {
                // Regular Tab or Indent Block
                document.execCommand('insertText', false, "\t");
            }
            onEditorInput();
        }

        // 3. Auto-Indent on Enter
        if (e.key === 'Enter') {
            e.preventDefault();
            const lastLine = val.substring(0, start).split('\n').pop();
            const indent = lastLine.match(/^\s*/)[0];
            const extra = lastLine.trim().endsWith(':') ? '\t' : '';
            document.execCommand('insertText', false, '\n' + indent + extra);
            onEditorInput();
        }
    }

    // --- AUTOCOMPLETE ENGINE ---
    function onEditorInput() {
        updateEditor();
        const val = elInput.value;
        const pos = elInput.selectionStart;
        
        // Find current word
        const lastWords = val.substring(0, pos).split(/[\s\t\n,]+/);
        const currentWord = lastWords[lastWords.length - 1];

        if (currentWord.length >= 2) {
            showSuggest(currentWord);
        } else {
            closeSuggest();
        }
    }

    function showSuggest(query) {
        filteredSuggestions = [];
        const q = query.toLowerCase();
        
        // Combine all DBs
        Object.keys(syntaxDB).forEach(type => {
            syntaxDB[type].forEach(item => {
                if (item.toLowerCase().startsWith(q)) {
                    filteredSuggestions.push({ text: item, type: type });
                }
            });
        });

        if (filteredSuggestions.length > 0) {
            currentSuggestIndex = 0;
            renderSuggestions();
            
            // Positioning (Crude but effective for this IDE)
            const lines = elInput.value.substring(0, elInput.selectionStart).split('\n');
            const top = lines.length * 24 + 15;
            const left = lines[lines.length-1].length * 8 + 40;
            
            elSuggest.style.top = top + "px";
            elSuggest.style.left = left + "px";
            elSuggest.style.display = 'block';
        } else {
            closeSuggest();
        }
    }

    function renderSuggestions() {
        elSuggest.innerHTML = filteredSuggestions.map((s, i) => `
            <div class="suggest-item ${i === currentSuggestIndex ? 'active' : ''}" onclick="applySuggestion('${s.text}')">
                ${s.text} <span class="suggest-type">${s.type.toUpperCase()}</span>
            </div>
        `).join('');
    }

    function applySuggestion(word) {
        const pos = elInput.selectionStart;
        const val = elInput.value;
        const startOfWord = val.substring(0, pos).search(/[a-zA-Z0-9_-]+$/);
        
        const newVal = val.substring(0, startOfWord) + word + val.substring(pos);
        elInput.value = newVal;
        elInput.selectionStart = elInput.selectionEnd = startOfWord + word.length;
        
        closeSuggest();
        updateEditor();
    }

    function closeSuggest() {
        elSuggest.style.display = 'none';
    }

    // --- RENDERER (Including Reflect Support) ---
    function updateEditor() {
        let code = elInput.value;
        
        // Gutter
        const lines = code.split('\n');
        elGutter.innerHTML = lines.map((_, i) => `<div class="line-number">${i+1}</div>`).join('');

        // Highlighting
        let h = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        h = h.replace(/("(?:[^"\\]|\\.)*")/g, '<span class="sk-string">$1</span>');
        h = h.replace(/(#.*)/g, '<span class="sk-comment">$1</span>');
        h = h.replace(/(\{.*?\})/g, '<span class="sk-var">$1</span>');
        h = h.replace(/(\.[a-zA-Z0-9_]+)(?=\()/g, '<span class="sk-java-method">$1</span>');
        h = h.replace(/\b([A-Z][a-zA-Z0-9]+)\b/g, '<span class="sk-java-class">$1</span>');
        
        const keys = [...syntaxDB.core, ...syntaxDB.reflect];
        const keyRegex = new RegExp(`\\b(${keys.join('|')})\\b`, 'g');
        h = h.replace(keyRegex, (m) => syntaxDB.reflect.includes(m) ? `<span class="sk-reflect-key">${m}</span>` : `<span class="sk-effect">${m}</span>`);

        elOutput.innerHTML = h + (code.endsWith('\n') ? ' ' : '');
    }

    function syncScroll() {
        elOutput.scrollTop = elGutter.scrollTop = elInput.scrollTop;
        elOutput.scrollLeft = elInput.scrollLeft;
    }

    // --- INITIALIZATION ---
    let currentUser = "Dev";
    let users = JSON.parse(localStorage.getItem('sk_users')) || { "Dev": { projects: { "Reflection.sk": "import:\n\tjava.lang.System\n\non load:\n\tset {t} to System.currentTimeMillis()" } } };
    
    function loadProject(name) {
        elInput.value = users[currentUser].projects[name];
        document.getElementById('current-filename').innerText = name;
        updateEditor();
    }

    window.onload = () => loadProject(Object.keys(users[currentUser].projects)[0]);
    function saveCurrentProject() { users[currentUser].projects[document.getElementById('current-filename').innerText] = elInput.value; localStorage.setItem('sk_users', JSON.stringify(users)); alert("Saved!"); }
</script>
</body>
</html>
