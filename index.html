<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skript IDE - Interpreter Edition</title>
    <style>
        :root {
            --bg: #282a36; --sidebar: #1e1f29; --fg: #f8f8f2;
            --purple: #bd93f9; --selection: #44475a; --comment: #6272a4;
            --cyan: #8be9fd; --pink: #ff79c6; --green: #50fa7b; 
            --orange: #ffb86c; --red: #ff5555; --yellow: #f1fa8c;
            --line-height: 22px;
        }
        
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: 'Inter', sans-serif; overflow: hidden; color: var(--fg); }
        .container { display: flex; height: 100vh; width: 100vw; position: absolute; top:0; left:0; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid #111; flex-shrink: 0; }
        .sidebar-header { padding: 15px; font-size: 11px; font-weight: bold; color: var(--purple); border-bottom: 1px solid #000; letter-spacing: 1px; }
        .file-list { flex: 1; overflow-y: auto; padding: 5px; }
        .file-item { padding: 8px 10px; cursor: pointer; font-size: 13px; color: #888; border-radius: 4px; margin-bottom: 2px; display: flex; justify-content: space-between; }
        .file-item:hover { background: var(--selection); color: #fff; }
        .file-item.active { background: #353745; color: var(--green); font-weight: bold; }
        .file-item .del { opacity: 0; color: var(--red); font-weight: bold; }
        .file-item:hover .del { opacity: 1; }

        /* Main */
        .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .toolbar { height: 42px; background: var(--sidebar); display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid #000; gap: 10px; flex-shrink: 0; }
        .tool-btn { background: var(--selection); border: 1px solid rgba(255,255,255,0.05); color: #ccc; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .tool-btn:hover { background: var(--purple); color: #000; }

        /* Editor */
        .editor-container { flex: 6; position: relative; display: flex; background: var(--bg); overflow: hidden; min-height: 200px; }
        .code-font { font-family: 'Fira Code', 'Consolas', monospace; font-size: 14px; line-height: var(--line-height); }
        #gutter { width: 50px; background: var(--sidebar); color: var(--comment); text-align: right; padding-top: 10px; border-right: 1px solid rgba(255,255,255,0.05); }
        .line-num { padding-right: 12px; height: var(--line-height); }
        .input-area { flex: 1; position: relative; overflow: hidden; }
        #editing, #highlighting { position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 10px; border: 0; tab-size: 4; white-space: pre; word-wrap: normal; box-sizing: border-box; overflow: auto; }
        #editing { z-index: 3; background: transparent; color: transparent; caret-color: #fff; outline: none; resize: none; }
        #highlighting { z-index: 2; pointer-events: none; }

        /* Simulator */
        .sim-container { flex: 4; background: #111; display: flex; flex-direction: column; font-family: 'Consolas', monospace; border-top: 2px solid var(--purple); min-height: 150px; }
        #sim-logs { flex: 1; padding: 12px; overflow-y: auto; font-size: 13px; color: #ddd; line-height: 1.5; }
        .sim-input-wrap { display: flex; background: #000; padding: 8px; border-top: 1px solid #333; align-items: center; }
        #sim-input { flex: 1; background: transparent; border: none; color: #fff; outline: none; padding-left: 10px; font-family: monospace; font-size: 13px; }
        .send-btn { background: var(--green); color: #000; border: none; padding: 4px 12px; font-weight: bold; cursor: pointer; font-size: 11px; border-radius: 2px; }

        /* Colors & Formatting */
        .mc-tag { opacity: 0.4; font-size: 0.9em; }
        .mc-0 { color: #000 !important; } .mc-1 { color: #00a !important; } .mc-2 { color: #0a0 !important; } 
        .mc-3 { color: #0aa !important; } .mc-4 { color: #a00 !important; } .mc-5 { color: #a0a !important; } 
        .mc-6 { color: #fa0 !important; } .mc-7 { color: #aaa !important; } .mc-8 { color: #555 !important; } 
        .mc-9 { color: #55f !important; } .mc-a { color: #5f5 !important; } .mc-b { color: #5ff !important; } 
        .mc-c { color: #f55 !important; } .mc-d { color: #f5f !important; } .mc-e { color: #ff5 !important; } 
        .mc-f { color: #fff !important; }
        
        .sk-ev { color: var(--pink); font-weight: bold; }
        .sk-eff { color: var(--cyan); }
        .sk-cond { color: var(--yellow); }
        .sk-exp { color: var(--purple); }
        .sk-var { color: var(--orange); }
        .sk-comment { color: var(--comment); font-style: italic; }
        .sk-str { color: #a6e22e; }
        
        .status-bar { height: 25px; background: var(--sidebar); border-top: 1px solid #111; display: flex; align-items: center; padding: 0 10px; font-size: 11px; color: var(--comment); }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-header">
            <span>PROJECT FILES</span>
            <button onclick="createNewFile()" style="background:transparent; border:none; color:var(--green); cursor:pointer; font-weight:bold;">+</button>
        </div>
        <div class="file-list" id="file-list"></div>
    </div>

    <div class="main">
        <div class="toolbar">
            <span id="cur-filename" style="font-weight:bold; color:var(--purple); font-size:13px;">script.sk</span>
            <div style="flex:1"></div>
            <button class="tool-btn" onclick="parseScript()" style="color:var(--green)">▶ RELOAD SCRIPT</button>
            <button class="tool-btn" onclick="saveFiles()">SAVE</button>
        </div>

        <div class="editor-container">
            <div id="gutter" class="code-font"></div>
            <div class="input-area">
                <div id="highlighting" class="code-font"></div>
                <textarea id="editing" class="code-font" spellcheck="false" oninput="updateEditor()" onscroll="syncScroll()" onkeydown="handleEditorKey(event)"></textarea>
            </div>
        </div>

        <div class="sim-container">
            <div class="sidebar-header" style="background:#151515; border-bottom:1px solid #222; display:flex; justify-content:space-between;">
                <span>SERVER CONSOLE</span>
                <span onclick="clearLog()" style="cursor:pointer; color:var(--red);">CLEAR</span>
            </div>
            <div id="sim-logs"></div>
            <div class="sim-input-wrap">
                <span style="color:var(--green); font-weight:bold;">&gt;</span>
                <input type="text" id="sim-input" placeholder="Type chat or /command..." onkeydown="checkChatEnter(event)">
                <button class="send-btn" onclick="processInput()">SEND</button>
            </div>
        </div>
        
        <div class="status-bar">
            <span id="status-msg">Ready</span>
            <div style="flex:1"></div>
            <span id="cursor-pos">Ln 1, Col 1</span>
        </div>
    </div>
</div>

<script>
    // --- FILES & STATE ---
    let files = JSON.parse(localStorage.getItem('sk_ultra_v5')) || {
        "chat.sk": "on chat:\n\tif message contains \"lag\":\n\t\tsend \"&cNo complaining!\" to player\n\t\tcancel event\n\ncommand /hello:\n\ttrigger:\n\t\tbroadcast \"&e%player% &7said hello!\""
    };
    let curFile = Object.keys(files)[0];
    let variables = {}; // Global variables store

    // --- INTERPRETER MEMORY ---
    let parsedEvents = {
        chat: [],
        commands: {}
    };

    // --- KEYWORDS ---
    const keywords = {
        "on join:": "ev", "on chat:": "ev", "command": "ev", "trigger:": "ev",
        "send": "eff", "broadcast": "eff", "set": "eff", "cancel": "eff", "stop": "eff",
        "if": "cond", "else": "cond", "player": "exp", "message": "exp"
    };

    function init() {
        renderFileList();
        loadFile(curFile);
        parseScript(); // Parse immediately on load
        logToSim("&e[System] Skript Engine v1.0 Loaded.");
    }

    // --- PARSER (The Brain) ---
    function parseScript() {
        const code = files[curFile];
        const lines = code.split('\n');
        
        // Reset Logic
        parsedEvents = { chat: [], commands: {} };
        let currentBlock = null; 
        let currentCmd = null;

        lines.forEach(line => {
            let trim = line.trim();
            if(!trim || trim.startsWith('#')) return;

            // 1. Detect 'on chat'
            if(trim.startsWith('on chat:')) {
                currentBlock = 'chat';
                currentCmd = null;
                return;
            }

            // 2. Detect 'command'
            if(trim.startsWith('command')) {
                // Extract command name e.g., "command /test:" -> "test"
                const match = trim.match(/command \/(\w+):?/);
                if(match) {
                    currentCmd = match[1];
                    parsedEvents.commands[currentCmd] = [];
                    currentBlock = 'command';
                }
                return;
            }

            // 3. Store Lines into current block
            if(currentBlock === 'chat') {
                parsedEvents.chat.push(trim);
            } else if (currentBlock === 'command' && currentCmd) {
                if(trim !== 'trigger:') { // Ignore trigger keyword, just get logic
                    parsedEvents.commands[currentCmd].push(trim);
                }
            }
        });

        logToSim(`&a[System] Reloaded ${curFile}.`);
        logToSim(`&7Loaded ${Object.keys(parsedEvents.commands).length} commands.`);
    }

    // --- EXECUTION ENGINE ---
    function processInput() {
        const input = document.getElementById('sim-input');
        const msg = input.value;
        if(!msg) return;

        // 1. Check if Command
        if(msg.startsWith('/')) {
            const cmdName = msg.substring(1).split(' ')[0];
            const args = msg.substring(1).split(' ').slice(1);
            
            if(parsedEvents.commands[cmdName]) {
                executeBlock(parsedEvents.commands[cmdName], { player: "User", message: msg, args: args });
            } else {
                logToSim("&fUnknown command.");
            }
        } 
        // 2. Chat Event
        else {
            let ctx = { player: "User", message: msg, cancelled: false };
            
            // Run "on chat" code
            if(parsedEvents.chat.length > 0) {
                executeBlock(parsedEvents.chat, ctx);
            }

            // If not cancelled, show message
            if(!ctx.cancelled) {
                logToSim(`&f${ctx.player}: &7${ctx.message}`);
            }
        }
        input.value = '';
    }

    // --- LINE EXECUTOR ---
    function executeBlock(lines, ctx) {
        let skipBlock = false; // For basic if statements

        for(let line of lines) {
            // Replace placeholders: %player%, %message%
            let processed = line.replace(/%player%/g, ctx.player)
                                .replace(/%message%/g, ctx.message);
            
            // Replace variables %{var}%
            processed = processed.replace(/%\{([^}]+)\}%/g, (m, vName) => variables[vName] || "<none>");

            // Handle "cancel event"
            if(processed.startsWith('cancel event')) {
                if(!skipBlock) ctx.cancelled = true;
            }

            // Handle "send"
            else if(processed.startsWith('send')) {
                if(!skipBlock) {
                    let text = processed.replace(/^send "(.*)"(?: to player)?/, '$1');
                    logToSim(text); // Send only to player (console)
                }
            }

            // Handle "broadcast"
            else if(processed.startsWith('broadcast')) {
                if(!skipBlock) {
                    let text = processed.replace(/^broadcast "(.*)"/, '$1');
                    logToSim(text);
                }
            }

            // Handle "set {var} to value"
            else if(processed.startsWith('set')) {
                if(!skipBlock) {
                    let match = processed.match(/set \{([^}]+)\} to "(.*)"/);
                    if(match) variables[match[1]] = match[2];
                }
            }

            // Handle "if" (Basic support: contains, is)
            else if(processed.startsWith('if')) {
                skipBlock = false; // Reset
                let condition = false;

                // "if message contains 'x'"
                if(processed.includes('contains')) {
                    let parts = processed.match(/if (.*) contains "(.*)"/);
                    if(parts) {
                        let target = parts[1] === 'message' ? ctx.message : (variables[parts[1]] || "");
                        if(target.includes(parts[2])) condition = true;
                    }
                }
                
                // If condition failed, set skipBlock to true so next indented lines are skipped
                // (Note: This is a simplified flat-parser. Real indentation logic is complex)
                // For this demo, we assume "if" affects the IMMEDIATE next lines until a non-indented line/end.
                if(!condition) skipBlock = true; 
            }
            
            // Handle "else" (Very basic)
            else if(processed.startsWith('else')) {
                skipBlock = !skipBlock; // Invert previous if result
            }
            
            // Reset skip if we hit a non-indented line? (Simplified: We assume flat structure for now)
        }
    }

    // --- UI HELPERS ---
    function checkChatEnter(e) { if(e.key === 'Enter') processInput(); }

    function logToSim(rawText) {
        const logs = document.getElementById('sim-logs');
        const div = document.createElement('div');
        div.innerHTML = formatConsole(rawText);
        logs.appendChild(div);
        logs.scrollTop = logs.scrollHeight;
    }

    function formatConsole(str) {
        let clean = str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        let out = "";
        let spans = 0;
        for (let i = 0; i < clean.length; i++) {
            if (clean[i] === '&' && "0123456789abcdefklmnor".includes(clean[i+1]?.toLowerCase())) {
                let code = clean[i+1].toLowerCase();
                if (code === 'r') { while (spans > 0) { out += "</span>"; spans--; } }
                else { out += `<span class="mc-${code}">`; spans++; }
                i++; continue;
            }
            out += clean[i];
        }
        while (spans > 0) { out += "</span>"; spans--; }
        return out;
    }

    // --- EDITOR FORMATTING ---
    function formatEditor(str) {
        let out = "";
        let spans = 0;
        for (let i = 0; i < str.length; i++) {
            if (str[i] === '&' && "0123456789abcdefklmnor".includes(str[i+1]?.toLowerCase())) {
                let code = str[i+1].toLowerCase();
                if (code === 'r') { while (spans > 0) { out += "</span>"; spans--; } out += '<span class="mc-tag">&r</span>'; }
                else { out += `<span class="mc-${code}"><span class="mc-tag">&${code}</span>`; spans++; }
                i++; continue;
            }
            out += str[i];
        }
        while (spans > 0) { out += "</span>"; spans--; }
        return out;
    }

    function updateEditor() {
        const elIn = document.getElementById('editing');
        const elOut = document.getElementById('highlighting');
        const code = elIn.value;
        files[curFile] = code;

        // Gutter
        document.getElementById('gutter').innerHTML = code.split('\n').map((_, i) => `<div class="line-num">${i+1}</div>`).join('');

        // Highlight
        let html = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        html = html.replace(/(#.*)/g, '<span class="sk-comment">$1</span>');
        html = html.replace(/("(?:[^"\\]|\\.)*")/g, m => `<span class="sk-str">${formatEditor(m.replace(/&amp;/g, '&'))}</span>`);
        html = html.replace(/(\{.*?\})/g, '<span class="sk-var">$1</span>');
        
        const tokens = html.split(/(\s+|[.,:!?;])/);
        elOut.innerHTML = tokens.map(token => {
            if(token.startsWith('<span')) return token;
            const clean = token.toLowerCase();
            return keywords[clean] ? `<span class="sk-${keywords[clean]}">${token}</span>` : token;
        }).join('') + (code.endsWith('\n') ? ' ' : '');
        
        syncScroll();
        document.getElementById('status-msg').innerText = "Unsaved";
    }

    function syncScroll() {
        const el = document.getElementById('editing');
        document.getElementById('highlighting').scrollTop = el.scrollTop;
        document.getElementById('highlighting').scrollLeft = el.scrollLeft;
        document.getElementById('gutter').scrollTop = el.scrollTop;
    }

    function handleEditorKey(e) {
        if(e.key === 'Tab') { e.preventDefault(); document.execCommand('insertText', false, "\t"); }
    }

    // --- FILE MANAGER ---
    function renderFileList() {
        document.getElementById('file-list').innerHTML = Object.keys(files).map(f => `
            <div class="file-item ${curFile === f ? 'active' : ''}" onclick="loadFile('${f}')">
                <span>${f}</span>
                <span class="del" onclick="delFile('${f}', event)">×</span>
            </div>`).join('');
    }
    function loadFile(f) { curFile = f; document.getElementById('editing').value = files[f]; document.getElementById('cur-filename').innerText = f; updateEditor(); renderFileList(); }
    function createNewFile() { const n = prompt("Filename:"); if(n && !files[n]) { files[n] = ""; loadFile(n); saveFiles(); } }
    function delFile(f, e) { e.stopPropagation(); if(confirm("Del?")) { delete files[f]; if(!Object.keys(files).length) files["new.sk"]=""; loadFile(Object.keys(files)[0]); saveFiles(); } }
    function saveFiles() { localStorage.setItem('sk_ultra_v5', JSON.stringify(files)); document.getElementById('status-msg').innerText = "Saved"; parseScript(); }
    function clearLog() { document.getElementById('sim-logs').innerHTML = ''; }

    init();
</script>
</body>
</html>
