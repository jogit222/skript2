<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skript IDE Pro - Precision Fixed</title>
    <style>
        :root {
            --bg: #282a36; --sidebar: #21222c; --fg: #f8f8f2;
            --purple: #bd93f9; --selection: #44475a; --comment: #6272a4;
            --cyan: #8be9fd; --pink: #ff79c6; --green: #50fa7b; 
            --orange: #ffb86c; --red: #ff5555; --yellow: #f1fa8c;
            --blue: #61afef; --gui-gold: #e5c07b;
        }
        
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: 'Segoe UI', sans-serif; overflow: hidden; color: var(--fg); }
        .container { display: flex; height: 100vh; width: 100vw; }
        
        /* Sidebar & Layout */
        .sidebar { width: 260px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.1); z-index: 10; }
        .sidebar-brand { padding: 20px; font-size: 18px; font-weight: bold; color: var(--purple); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .project-list { flex: 1; padding: 10px; overflow-y: auto; }
        .project-item { padding: 10px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-bottom: 5px; display: flex; justify-content: space-between; transition: 0.2s; }
        .project-item:hover { background: var(--selection); }
        .project-item.active { background: var(--purple); color: white; }
        
        .main { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        .toolbar { height: 50px; background: var(--sidebar); display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid rgba(255,255,255,0.1); justify-content: space-between; }
        .tool-btn { background: var(--selection); border: 1px solid rgba(255,255,255,0.1); color: var(--fg); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; transition: 0.2s; }
        .tool-btn:hover { background: rgba(255,255,255,0.1); }
        .btn-green { color: var(--green); border-color: var(--green); }
        .btn-yellow { color: var(--yellow); border-color: var(--yellow); }
        .status-bar { height: 25px; background: var(--sidebar); border-top: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; padding: 0 10px; font-size: 11px; color: var(--comment); justify-content: space-between;}
        
        /* --- EDITOR CORE FIXES --- */
        .editor-container { flex: 1; position: relative; display: flex; overflow: hidden; }
        
        /* Common styles to ensure perfect alignment */
        .code-font {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* Exact same font stack */
            font-size: 14px;
            line-height: 16px; /* FIXED PIXEL HEIGHT - Prevents drift */
        }

        #gutter { 
            width: 45px; 
            background: var(--sidebar); 
            color: var(--comment); 
            padding: 15px 5px; /* Top padding must match editor */
            text-align: right; 
            border-right: 1px solid rgba(255,255,255,0.1); 
            user-select: none;
            box-sizing: border-box; /* Ensures padding doesn't affect calculation */
        }

        .input-area { flex: 1; position: relative; overflow: hidden; }

        #editing, #highlighting { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            margin: 0; 
            padding: 15px; /* Top padding must match gutter */
            border: 0; 
            tab-size: 4; 
            white-space: pre; 
            box-sizing: border-box; 
            overflow: auto; 
        }

        #editing { z-index: 3; background: transparent; color: transparent; caret-color: var(--fg); outline: none; resize: none; }
        #highlighting { z-index: 2; pointer-events: none; }

        /* Modals and Highlighting Colors (Same as before) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; align-items: center; justify-content: center; }
        .modal { background: var(--sidebar); padding: 30px; border-radius: 12px; width: 400px; border: 1px solid var(--purple); max-height: 80vh; overflow-y: auto; }
        .input-field { width: 100%; background: var(--bg); border: 1px solid rgba(255,255,255,0.1); color: var(--fg); padding: 12px; border-radius: 6px; margin-bottom: 15px; box-sizing: border-box; }
        .error-item { background: rgba(255, 85, 85, 0.1); border-left: 3px solid var(--red); padding: 10px; margin-bottom: 8px; font-size: 12px; }
        .error-line { font-weight: bold; color: var(--red); }
        .success-msg { color: var(--green); text-align: center; padding: 20px; font-weight: bold; }

        .sk-event { color: var(--pink); font-weight: bold; }
        .sk-effect { color: var(--cyan); }
        .sk-var { color: var(--orange); }
        .sk-comment { color: var(--comment); font-style: italic; }
        .sk-string { color: var(--green); }
        .sk-bracket { color: var(--purple); font-weight: bold; }
        .sk-addon { color: var(--blue); font-style: italic; } 
        .sk-gui { color: var(--gui-gold); font-weight: bold; }
        .addon-badge { background: var(--gui-gold); color: #000; font-size: 9px; padding: 2px 6px; border-radius: 10px; font-weight: bold; margin-left: 10px; }
    </style>
</head>
<body>

<div id="auth-modal" class="modal-overlay" style="display:flex;">
    <div class="modal">
        <h2 id="auth-title" style="margin-top:0; color:var(--purple)">Welcome Back</h2>
        <input type="text" id="auth-user" class="input-field" placeholder="Username">
        <input type="password" id="auth-pass" class="input-field" placeholder="Password">
        <button class="tool-btn" style="width:100%; padding:12px; background:var(--purple); color:white; border:none;" onclick="handleAuth()">LOGIN / SIGN UP</button>
        <p id="auth-msg" style="font-size: 11px; color: var(--red); margin-top: 10px;"></p>
    </div>
</div>

<div id="syntax-modal" class="modal-overlay">
    <div class="modal">
        <h2 style="margin-top:0; color:var(--yellow)">Syntax Report</h2>
        <div id="syntax-results"></div>
        <button class="tool-btn" style="width:100%; margin-top:15px;" onclick="document.getElementById('syntax-modal').style.display='none'">CLOSE</button>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-brand">
            Skript IDE <small style="font-size: 10px; opacity: 0.5;">PRO</small>
            <div style="font-size: 10px; color: var(--gui-gold); margin-top:5px;">‚ú¶ Precision Engine</div>
        </div>
        <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05);">
            <div id="user-display" style="font-size: 12px; color: var(--cyan); margin-bottom: 10px;">User: Not Logged In</div>
            <button class="tool-btn" style="width:100%" onclick="createNewProject()">+ NEW PROJECT</button>
        </div>
        <div class="project-list" id="project-list"></div>
        <div style="padding: 15px; display:flex; gap:5px;">
            <button class="tool-btn" style="flex:1" onclick="logout()">LOGOUT</button>
        </div>
    </div>

    <div class="main">
        <div class="toolbar">
            <div style="display:flex; align-items:center;">
                <span id="current-filename" style="color: var(--purple); font-weight: bold;">No file open</span>
                <span id="addon-indicator" class="addon-badge" style="display:none;">GUI MODE</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="tool-btn btn-yellow" onclick="runSyntaxCheck()">‚ö†Ô∏è CHECK SYNTAX</button>
                <button class="tool-btn btn-green" onclick="saveCurrentProject(false)">üíæ SAVE</button>
                <button class="tool-btn" onclick="copyCode()">üìã COPY</button>
            </div>
        </div>
        
        <div class="editor-container">
            <div id="gutter" class="code-font">1</div>
            <div class="input-area">
                <pre id="highlighting" class="code-font"></pre>
                <textarea id="editing" class="code-font" spellcheck="false" oninput="onEditorInput()" onscroll="syncScroll()"></textarea>
            </div>
        </div>

        <div class="status-bar">
            <span id="save-status">All changes saved</span>
            <span id="cursor-pos">Ln 1, Col 1</span>
        </div>
    </div>
</div>

<script>
    const elInput = document.getElementById('editing');
    const elOutput = document.getElementById('highlighting');
    const elGutter = document.getElementById('gutter');
    const elProjList = document.getElementById('project-list');
    const elSaveStatus = document.getElementById('save-status');

    let saveTimer; 

    const syntaxDB = {
        core: ["command", "trigger:", "function", "return", "options:", "variables:", "aliases:", "on join:", "on quit:", "on load:", "on unload:", "on skript load:", "on damage:", "on death:", "on rightclick:", "on leftclick:", "on place:", "on break:", "on chat:", "on command:", "on drop:", "on pickup:", "on consume:", "on respawn:", "on connect:", "on disconnect:", "send", "broadcast", "set", "add", "remove", "delete", "clear", "wait", "stop", "cancel event", "apply", "teleport", "give", "drop", "spawn", "kill", "damage", "heal", "repair", "execute console command", "make player execute", "if", "else", "else if", "while", "loop", "loop-player", "loop-value", "loop-index", "loop-entity", "continue", "exit", "arg-1", "arg-2", "player", "victim", "attacker", "event-block", "event-location", "event-item", "uuid", "name of", "distance between", "location of", "metadata", "now", "unix timestamp", "health of", "max health of"],
        skriptgui: ["create a gui with virtual chest inventory", "create a gui with virtual hopper inventory", "create a gui with virtual dropper inventory", "open last created gui", "open the last created gui", "edit gui", "edit last created gui", "make gui slot", "make next gui slot", "format gui slot", "to run:", "to close:", "to do nothing", "unstealable", "to nothing", "gui-inventory", "gui-slot", "gui-click-type", "gui-cursor", "gui-item", "gui-name", "run function", "from function", "change gui shape"],
        addons: ["nbt compound", "nbt list", "set nbt", "spawn armor stand", "update score", "create team", "open virtual chest", "format slot", "open gui", "login to discord", "create embed", "send message", "reply with", "offline player", "permission", "parse", "replace", "contains"]
    };
    const dictionary = [...syntaxDB.core, ...syntaxDB.skriptgui, ...syntaxDB.addons];

    let users = JSON.parse(localStorage.getItem('sk_users')) || {};
    let currentUser = null;
    let currentProjectId = null;

    function handleAuth() {
        const u = document.getElementById('auth-user').value.trim();
        const p = document.getElementById('auth-pass').value.trim();
        if(!u || !p) return;
        if (users[u]) {
            if (users[u].pass === p) login(u);
            else document.getElementById('auth-msg').innerText = "Incorrect password!";
        } else {
            users[u] = { pass: p, projects: { "gui-test.sk": "command /gui:\n\ttrigger:\n\t\tcreate a gui with virtual chest inventory with 3 rows named \"&8Menu\":\n\t\t\tmake gui slot 13 with diamond named \"&bClick Me\":\n\t\t\t\tto run:\n\t\t\t\t\tsend \"Clicked!\"\n\t\topen the last created gui to player" } };
            saveUsers();
            login(u);
        }
    }

    function login(username) {
        currentUser = username;
        document.getElementById('auth-modal').style.display = 'none';
        document.getElementById('user-display').innerText = "User: " + username;
        renderProjectList();
        loadProject(Object.keys(users[username].projects)[0]);
    }

    function logout() { location.reload(); }
    function saveUsers() { localStorage.setItem('sk_users', JSON.stringify(users)); }

    function renderProjectList() {
        elProjList.innerHTML = "";
        const projs = users[currentUser].projects;
        Object.keys(projs).forEach(name => {
            const div = document.createElement('div');
            div.className = `project-item ${currentProjectId === name ? 'active' : ''}`;
            div.innerHTML = `<span>üìÑ ${name}</span><span onclick="deleteProject('${name}', event)" style="color:var(--red)">√ó</span>`;
            div.onclick = () => loadProject(name);
            elProjList.appendChild(div);
        });
    }

    function loadProject(name) {
        if(!name) return;
        currentProjectId = name;
        elInput.value = users[currentUser].projects[name];
        document.getElementById('current-filename').innerText = name;
        updateEditor();
        renderProjectList();
    }

    function saveCurrentProject(silent = false) {
        if(!currentUser || !currentProjectId) return;
        users[currentUser].projects[currentProjectId] = elInput.value;
        saveUsers();
        elSaveStatus.innerText = "All changes saved";
        elSaveStatus.style.color = "var(--green)";
        if(!silent) alert("Project Saved!");
    }

    function createNewProject() {
        const name = prompt("Project Name (e.g., gui.sk):");
        if(name && !users[currentUser].projects[name]) {
            users[currentUser].projects[name] = "# New Skript File\n";
            saveUsers();
            loadProject(name);
        }
    }

    function deleteProject(name, e) {
        e.stopPropagation();
        if(confirm(`Delete ${name}?`)) {
            delete users[currentUser].projects[name];
            saveUsers();
            renderProjectList();
            if(currentProjectId === name) {
                const keys = Object.keys(users[currentUser].projects);
                if(keys.length > 0) loadProject(keys[0]);
                else { currentProjectId = null; elInput.value = ""; }
            }
        }
    }

    function runSyntaxCheck() {
        const lines = elInput.value.split('\n');
        const errors = [];
        const modal = document.getElementById('syntax-modal');
        const results = document.getElementById('syntax-results');

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const trimmed = line.trim();
            const indent = line.search(/\S|$/); 
            if (trimmed === "" || trimmed.startsWith("#")) continue;
            if (/^(command|trigger|if|else|loop|while|function|on \w+|options|variables)/.test(trimmed)) {
                if (!trimmed.endsWith(":")) errors.push({line: i + 1, msg: "Possible missing colon ':' at end of line."});
            }
            if (i > 0) {
                const prevLine = lines[i-1];
                const prevTrimmed = prevLine.trim();
                const prevIndent = prevLine.search(/\S|$/);
                if (prevTrimmed.endsWith(":") && indent <= prevIndent && prevTrimmed.length > 0) {
                     errors.push({line: i + 1, msg: "Indentation error. This line should be indented further than line " + i});
                }
            }
            if (trimmed.includes("set %") || trimmed.includes("add %")) errors.push({line: i + 1, msg: "Incorrect variable usage. Use {var} instead of %var%."});
        }

        results.innerHTML = "";
        if (errors.length === 0) results.innerHTML = `<div class="success-msg">‚úÖ No basic errors found!</div>`;
        else errors.forEach(err => {
            results.innerHTML += `<div class="error-item"><span class="error-line">Line ${err.line}:</span> ${err.msg}</div>`;
        });
        modal.style.display = "flex";
    }

    elInput.addEventListener('keydown', function(e) {
        const start = this.selectionStart;
        const val = this.value;

        if (e.key === 'Enter') {
            e.preventDefault();
            const lastNewLine = val.lastIndexOf('\n', start - 1);
            const lineStart = lastNewLine + 1;
            const currentLine = val.substring(lineStart, start);
            const match = currentLine.match(/^\s*/);
            const currentIndent = match ? match[0] : "";
            const trimmedLine = currentLine.trim();
            let extraIndent = "";
            if (trimmedLine.endsWith(':') || trimmedLine.endsWith('{')) extraIndent = "\t";
            
            const insertion = "\n" + currentIndent + extraIndent;
            this.value = val.substring(0, start) + insertion + val.substring(this.selectionEnd);
            this.selectionStart = this.selectionEnd = start + insertion.length;
            
            const lineHeight = 24; // Updated to match CSS
            const currentLineNum = val.substr(0, start).split("\n").length;
            if (currentLineNum * lineHeight > this.scrollTop + this.clientHeight) this.scrollTop += lineHeight;
            onEditorInput();
            return; 
        }

        const pairs = {'{':'}', '[':']', '(':')', '"':'"', "'":"'"};
        if (pairs[e.key]) {
            e.preventDefault();
            this.value = val.substring(0, start) + e.key + pairs[e.key] + val.substring(this.selectionEnd);
            this.selectionStart = this.selectionEnd = start + 1;
            onEditorInput();
        }

        if (e.key === 'Tab') {
            e.preventDefault();
            const lastWord = val.substring(0, start).split(/[\s\n\t]+/).pop();
            if (lastWord.length > 1) {
                const match = dictionary.find(w => w.startsWith(lastWord.toLowerCase()));
                if (match) {
                    const wordStart = start - lastWord.length;
                    this.value = val.substring(0, wordStart) + match + val.substring(this.selectionEnd);
                    this.selectionStart = this.selectionEnd = wordStart + match.length;
                    onEditorInput();
                } else {
                    this.value = val.substring(0, start) + "\t" + val.substring(this.selectionEnd);
                    this.selectionStart = this.selectionEnd = start + 1;
                }
            } else {
                this.value = val.substring(0, start) + "\t" + val.substring(this.selectionEnd);
                this.selectionStart = this.selectionEnd = start + 1;
            }
        }
        
        setTimeout(() => {
            const lines = val.substr(0, this.selectionStart).split("\n");
            document.getElementById('cursor-pos').innerText = `Ln ${lines.length}, Col ${lines[lines.length-1].length + 1}`;
        }, 10);
    });

    function onEditorInput() {
        updateEditor();
        elSaveStatus.innerText = "Unsaved changes...";
        elSaveStatus.style.color = "var(--orange)";
        clearTimeout(saveTimer);
        saveTimer = setTimeout(() => { saveCurrentProject(true); }, 2000);
    }

    function updateEditor() {
        let code = elInput.value;
        // Fix blank line issue at end by adding invisible space so gutter counts it
        elGutter.innerHTML = Array.from({length: code.split('\n').length}, (_, i) => i + 1).join('<br>');

        let h = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        h = h.replace(/("(?:[^"\\]|\\.)*")/g, '<span class="sk-string">$1</span>');
        h = h.replace(/(#.*)/g, '<span class="sk-comment">$1</span>');
        h = h.replace(/(\{.*?\})/g, '<span class="sk-var">$1</span>');
        h = h.replace(/^(on\s+.*:)/gm, '<span class="sk-event">$1</span>');

        const coreSorted = syntaxDB.core.sort((a,b) => b.length - a.length);
        const coreRegex = new RegExp(`\\b(${coreSorted.map(k => k.replace(/[^a-zA-Z0-9\-]/g, '\\$&')).join('|')})\\b`, 'g');
        h = h.replace(coreRegex, '<span class="sk-effect">$1</span>');

        const guiSorted = syntaxDB.skriptgui.sort((a,b) => b.length - a.length);
        const guiRegex = new RegExp(`\\b(${guiSorted.map(k => k.replace(/ /g, '\\s+')).join('|')})`, 'g');
        h = h.replace(guiRegex, '<span class="sk-gui">$1</span>');

        const addonSorted = syntaxDB.addons.sort((a,b) => b.length - a.length);
        const addonRegex = new RegExp(`\\b(${addonSorted.map(k => k.replace(/ /g, '\\s+')).join('|')})\\b`, 'g');
        h = h.replace(addonRegex, '<span class="sk-addon">$1</span>');
        h = h.replace(/[\(\)\[\]\{\}]/g, '<span class="sk-bracket">$&</span>');

        const hasGui = guiSorted.some(k => code.includes(k));
        document.getElementById('addon-indicator').style.display = hasGui ? 'inline-block' : 'none';

        elOutput.innerHTML = h + (code.endsWith('\n') ? ' ' : '');
    }

    function syncScroll() {
        elOutput.scrollTop = elGutter.scrollTop = elInput.scrollTop;
        elOutput.scrollLeft = elInput.scrollLeft;
    }

    function copyCode() {
        navigator.clipboard.writeText(elInput.value);
        alert("Code copied to clipboard!");
    }
</script>
</body>
</html>
