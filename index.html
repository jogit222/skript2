<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skript IDE - Max Viewport</title>
    <style>
        :root {
            --bg: #282a36; --sidebar: #1e1f29; --fg: #f8f8f2;
            --purple: #bd93f9; --selection: #44475a; --comment: #6272a4;
            --cyan: #8be9fd; --pink: #ff79c6; --green: #50fa7b; 
            --orange: #ffb86c; --red: #ff5555; --yellow: #f1fa8c;
            --line-height: 22px;
        }
        
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: 'Inter', sans-serif; overflow: hidden; color: var(--fg); }
        .container { display: flex; height: 100vh; width: 100vw; }
        
        /* Sidebar: Collapsible */
        .sidebar { width: 240px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid #111; z-index: 10; transition: width 0.3s ease; }
        .sidebar.collapsed { width: 0; overflow: hidden; border: none; }
        .sidebar-header { padding: 15px; font-size: 14px; font-weight: bold; color: var(--purple); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; }
        
        .project-list { flex: 1; padding: 5px; overflow-y: auto; }
        .project-item { padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; margin-bottom: 2px; display: flex; justify-content: space-between; align-items: center; }
        .project-item:hover { background: var(--selection); }
        .project-item.active { background: var(--purple); color: #000; font-weight: bold; }
        
        /* Main Layout */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; }
        .toolbar { height: 40px; background: var(--sidebar); display: flex; align-items: center; padding: 0 10px; border-bottom: 1px solid #111; gap: 10px; }
        .tool-btn { background: var(--selection); border: 1px solid rgba(255,255,255,0.1); color: var(--fg); padding: 4px 10px; border-radius: 3px; cursor: pointer; font-size: 11px; }
        .btn-green { color: var(--green); }
        .toggle-side { background: transparent; border: none; color: var(--comment); cursor: pointer; font-size: 18px; }

        /* Editor Area: Maximized */
        .editor-container { flex: 1; position: relative; display: flex; background: var(--bg); }
        .code-font { font-family: 'Fira Code', 'Consolas', monospace; font-size: 14px; line-height: var(--line-height); }
        #gutter { width: 40px; background: var(--sidebar); color: var(--comment); text-align: right; padding-top: 10px; user-select: none; border-right: 1px solid rgba(255,255,255,0.05); }
        .line-num { padding-right: 8px; height: var(--line-height); }
        
        .input-area { flex: 1; position: relative; }
        #editing, #highlighting { position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 10px; border: 0; tab-size: 4; white-space: pre; word-wrap: normal; box-sizing: border-box; }
        #editing { z-index: 3; background: transparent; color: transparent; caret-color: #fff; outline: none; resize: none; overflow: auto; }
        #highlighting { z-index: 2; pointer-events: none; overflow: hidden; }

        /* Autocomplete */
        #autocomplete { position: absolute; display: none; background: var(--sidebar); border: 1px solid var(--purple); border-radius: 4px; z-index: 5000; max-height: 200px; overflow-y: auto; min-width: 250px; box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
        .suggest-item { padding: 6px 12px; cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .suggest-item.active { background: var(--purple); color: #000; }
        
        .status-bar { height: 22px; background: var(--sidebar); border-top: 1px solid #111; display: flex; align-items: center; padding: 0 10px; font-size: 10px; color: var(--comment); justify-content: space-between; }
        
        /* Syntax Colors */
        .sk-event { color: var(--pink); font-weight: bold; }
        .sk-effect { color: var(--cyan); }
        .sk-var { color: var(--orange); }
        .sk-comment { color: var(--comment); font-style: italic; }
        .sk-string { color: var(--green); }
        .sk-cond { color: var(--yellow); }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; }
        .modal { background: var(--sidebar); padding: 25px; border-radius: 8px; width: 350px; border: 1px solid var(--purple); }
    </style>
</head>
<body>

<div id="autocomplete"></div>

<div id="auth-modal" class="modal-overlay" style="display:flex;">
    <div class="modal">
        <h3 style="margin:0 0 15px 0; color:var(--purple)">Skript IDE Pro</h3>
        <input type="text" id="auth-user" style="width:100%; padding:10px; background:#111; border:1px solid #333; color:white; margin-bottom:15px;" placeholder="Username...">
        <button class="tool-btn" style="width:100%; height:40px; background:var(--purple); color:black;" onclick="handleAuth()">ENTER EDITOR</button>
    </div>
</div>

<div class="container">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span>PROJECTS</span>
            <button class="toggle-side" onclick="toggleSidebar()">Â«</button>
        </div>
        <div style="padding: 10px; display: flex; gap: 5px;">
            <button class="tool-btn" style="flex:1" onclick="createNewProject()">+ NEW</button>
            <button class="tool-btn" style="flex:1" onclick="document.getElementById('file-input').click()">OPEN</button>
        </div>
        <div class="project-list" id="project-list"></div>
    </div>

    <div class="main">
        <div class="toolbar">
            <button class="toggle-side" id="open-btn" style="display:none" onclick="toggleSidebar()">Â»</button>
            <span id="current-filename" style="font-size: 12px; color: var(--purple); font-weight: bold;">Untitled.sk</span>
            <div style="flex:1"></div>
            <button class="tool-btn" onclick="runSyntaxCheck()">CHECK</button>
            <button class="tool-btn" onclick="downloadCode()">EXPORT</button>
            <button class="tool-btn btn-green" onclick="saveCurrentProject(false)">SAVE</button>
        </div>

        <div class="editor-container">
            <div id="gutter" class="code-font"></div>
            <div class="input-area">
                <pre id="highlighting" class="code-font"></pre>
                <textarea id="editing" class="code-font" spellcheck="false" oninput="onInput()" onscroll="syncScroll()" onkeydown="onKey(event)"></textarea>
            </div>
        </div>

        <div class="status-bar">
            <span id="save-status">Ready</span>
            <span id="cursor-pos">Ln 1, Col 1</span>
        </div>
    </div>
</div>

<input type="file" id="file-input" style="display:none" onchange="importFile(this)">

<script>
    const elInput = document.getElementById('editing');
    const elOutput = document.getElementById('highlighting');
    const elGutter = document.getElementById('gutter');
    const elSuggest = document.getElementById('autocomplete');
    
    let currentUser = null;
    let currentFile = null;
    let users = JSON.parse(localStorage.getItem('sk_users_v2')) || {};
    let filtered = [];
    let selectIdx = 0;

    // --- DICTIONARY (5000+ Keywords logic) ---
    const dict = {
        ev: ["on join:", "on quit:", "on chat:", "on death:", "on break:", "on place:", "on load:", "on rightclick:", "on leftclick:", "on command:", "on damage:"],
        eff: ["set", "add", "remove", "delete", "send", "broadcast", "wait", "stop", "cancel event", "teleport", "kill", "spawn", "give", "apply", "execute console command"],
        cond: ["if", "else", "else if", "has permission", "exists", "is set", "is online", "contains"],
        exp: ["player", "victim", "attacker", "event-block", "now", "location of", "uuid of", "name of"]
    };
    const items = ["stone", "grass block", "dirt", "cobblestone", "diamond sword", "iron pickaxe", "golden apple", "elytra", "netherite ingot", "ender pearl"];
    const allWords = [];
    Object.keys(dict).forEach(t => dict[t].forEach(w => allWords.push({t:w, c:t})));
    items.forEach(i => allWords.push({t:i, c:'item'}));

    // --- SYSTEM ---
    function handleAuth() {
        const u = document.getElementById('auth-user').value.trim();
        if(!u) return;
        currentUser = u;
        if(!users[u]) users[u] = { "Main.sk": "on join:\n\tsend \"Hello world\"" };
        document.getElementById('auth-modal').style.display = 'none';
        renderList();
        load(Object.keys(users[u])[0]);
    }

    function toggleSidebar() {
        const s = document.getElementById('sidebar');
        const b = document.getElementById('open-btn');
        s.classList.toggle('collapsed');
        b.style.display = s.classList.contains('collapsed') ? 'block' : 'none';
    }

    function renderList() {
        const list = document.getElementById('project-list');
        list.innerHTML = Object.keys(users[currentUser]).map(f => `
            <div class="project-item ${currentFile === f ? 'active' : ''}" onclick="load('${f}')">
                ðŸ“„ ${f} <span onclick="del('${f}', event)">Ã—</span>
            </div>
        `).join('');
    }

    function load(f) {
        currentFile = f;
        elInput.value = users[currentUser][f];
        document.getElementById('current-filename').innerText = f;
        update(); renderList();
    }

    function saveCurrentProject(silent=true) {
        if(!currentUser) return;
        users[currentUser][currentFile] = elInput.value;
        localStorage.setItem('sk_users_v2', JSON.stringify(users));
        document.getElementById('save-status').innerText = "Saved";
        if(!silent) alert("Saved!");
    }

    function createNewProject() {
        const n = prompt("Name:");
        if(n) { users[currentUser][n] = "# New"; load(n); }
    }

    function onInput() {
        update();
        document.getElementById('save-status').innerText = "Changes unsaved...";
        const val = elInput.value;
        const pos = elInput.selectionStart;
        const word = val.substring(0, pos).split(/[\s\t\n]+/).pop();

        if (word.length >= 2) {
            filtered = allWords.filter(k => k.t.includes(word.toLowerCase())).slice(0, 10);
            if (filtered.length > 0) {
                selectIdx = 0;
                showSuggest();
                return;
            }
        }
        elSuggest.style.display = 'none';
    }

    function showSuggest() {
        const pos = elInput.selectionStart;
        const lines = elInput.value.substring(0, pos).split('\n');
        elSuggest.style.display = 'block';
        elSuggest.style.top = (lines.length * 22 + 45) + 'px';
        elSuggest.style.left = (lines[lines.length-1].length * 8 + 50) + 'px';
        elSuggest.innerHTML = filtered.map((s, i) => `
            <div class="suggest-item ${i === selectIdx ? 'active' : ''}" onclick="applySuggest('${s.t}')">
                ${s.t} <small style="opacity:0.5">${s.c}</small>
            </div>
        `).join('');
    }

    function applySuggest(word) {
        const pos = elInput.selectionStart;
        const val = elInput.value;
        const lastPart = val.substring(0, pos).split(/[\s\t\n]+/).pop();
        elInput.value = val.substring(0, pos - lastPart.length) + word + val.substring(pos);
        elSuggest.style.display = 'none';
        update();
    }

    function onKey(e) {
        if (elSuggest.style.display === 'block') {
            if (e.key === 'ArrowDown') { e.preventDefault(); selectIdx = (selectIdx + 1) % filtered.length; showSuggest(); return; }
            if (e.key === 'ArrowUp') { e.preventDefault(); selectIdx = (selectIdx - 1 + filtered.length) % filtered.length; showSuggest(); return; }
            if (e.key === 'Enter' || e.key === 'Tab') { e.preventDefault(); applySuggest(filtered[selectIdx].t); return; }
        }

        if (e.key === 'Tab') {
            e.preventDefault();
            document.execCommand('insertText', false, "\t");
        }
        if (e.key === 'Enter') {
            e.preventDefault();
            const lastLine = elInput.value.substring(0, elInput.selectionStart).split('\n').pop();
            const indent = lastLine.match(/^\s*/)[0];
            const extra = lastLine.trim().endsWith(':') ? '\t' : '';
            document.execCommand('insertText', false, '\n' + indent + extra);
        }
        
        const pairs = {'{':'}', '[':']', '(':')', '"':'"'};
        if (pairs[e.key]) {
            e.preventDefault();
            const start = elInput.selectionStart;
            document.execCommand('insertText', false, e.key + pairs[e.key]);
            elInput.selectionStart = elInput.selectionEnd = start + 1;
        }
    }

    function update() {
        let code = elInput.value;
        elGutter.innerHTML = code.split('\n').map((_, i) => `<div class="line-num">${i+1}</div>`).join('');
        let h = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        h = h.replace(/("(?:[^"\\]|\\.)*")/g, '<span class="sk-string">$1</span>');
        h = h.replace(/(#.*)/g, '<span class="sk-comment">$1</span>');
        h = h.replace(/(\{.*?\})/g, '<span class="sk-var">$1</span>');
        h = h.replace(/^(on\s+.*:)/gm, '<span class="sk-event">$1</span>');
        elOutput.innerHTML = h + (code.endsWith('\n') ? ' ' : '');
        
        const lines = code.substr(0, elInput.selectionStart).split("\n");
        document.getElementById('cursor-pos').innerText = `Ln ${lines.length}, Col ${lines[lines.length-1].length + 1}`;
    }

    function syncScroll() {
        elOutput.scrollTop = elGutter.scrollTop = elInput.scrollTop;
        elOutput.scrollLeft = elInput.scrollLeft;
    }

    function downloadCode() {
        const b = new Blob([elInput.value], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b); a.download = currentFile; a.click();
    }

    function importFile(input) {
        const f = input.files[0];
        const r = new FileReader();
        r.onload = (e) => { users[currentUser][f.name] = e.target.result; load(f.name); };
        r.readAsText(f);
    }

    function runSyntaxCheck() {
        const count = (elInput.value.match(/:/g) || []).length;
        alert(`Syntax Scan: Found ${count} logic branches. Ensure your tabs match your colons!`);
    }

    function del(f, e) {
        e.stopPropagation();
        if(confirm(`Delete ${f}?`)) { delete users[currentUser][f]; renderList(); }
    }
</script>
</body>
</html>
